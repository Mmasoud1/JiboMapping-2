<!-- 
=========================================================
* Jibo Data Mapping Demo 
=========================================================

* @see {@link  (Github link to add here)}
* @description   Analytical tool for Jibo project collected data
*
* @version 1.0.0 
*
* @author Mohamed Masoud,   PI:  Dr. Robert Morris
=========================================================
* @file             Jibo Mapping
=========================================================
-->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Jibo Mapping</title>
  <link rel="shortcut icon" href="#">
  <link rel="stylesheet" type="text/css" href="js/libs/webix/webix.css">

    <!-- Font Awesome Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


  <script src="js/libs/webix/webix.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js" type="text/javascript"></script>

  <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.js"></script>
  <!-- bundle for panda like   https://danfo.jsdata.org/-->
  <script src="https://cdn.jsdelivr.net/npm/danfojs@1.1.2/lib/bundle.js"></script>
  <script src="js/libs/Dropbox-sdk.min.js"></script>
  <script src="js/libs/jquery-3.5.1.js"></script>
  <script src="js/libs/papaparse.min.js"></script>  
  <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>


<style>
  /*table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
  }*/

  th, td {
    border-style:solid;
    border-color: #96D4D4;
  }

  .my-popup {
    bottom: 20px !important;
    right: 20px !important;
    max-width: 20vw;
  }


/* For tabview, change this color as needed */
.webix_el_tabbar .webix_item_tab.webix_selected {
  background-color: #2596be; /* Selected tab background color */
  border-color: #2596be; /* Selected tab border color */
  color: white !important; /* Selected tab text color */
}

.webix_item_tab .webix_icon {
  font-size: 14px;
}

.webix_el_tabbar .webix_item_tab {
  border-color: white;
  color: black; /* Unselected tab text color */
  background-color: white; /* Unselected tab background color */
  font-size: 14px;
}

/* Remove hover effect */
.webix_el_tabbar .webix_item_tab:hover {
  background-color: white;
  color: black; /* Ensure text color remains black */
}

/* Ensure selected tab retains background color and text color on hover */
.webix_el_tabbar .webix_item_tab.webix_selected:hover {
  background-color: #2596be;
  border-color: #2596be;
  color: white !important; /* Ensure text color remains white */
}

/* Ensure selected tab retains background color and text color when not hovered */
.webix_el_tabbar .webix_item_tab.webix_selected {
  color: white !important; /* Ensure text color remains white */
}

.webix_after_all_tabs {
  display: none;
}

/* Dropbox Access Status Styles */
.valid-status {
    color: green;
    font-weight: bold;
}
.invalid-status {
    color: red;
    font-weight: bold;
}

/* Style for settings icon */
.fa-settings {
    font-size: 20px;
    cursor: pointer;

</style>


</head>
  
<body>
 
  <script>

 
    //*************************************** Dropbox JSON Access *******************************************//

    // Global variable to hold Dropbox client
    var dbx = null;    

    // Function to load settings from localStorage
    function loadSettings() {
        return {
            refreshToken: localStorage.getItem('refresh_token') || '',
            clientId: localStorage.getItem('client_id') || '',
            clientSecret: localStorage.getItem('client_secret') || '',
            accessToken: localStorage.getItem('access_token') || ''
        };
    }

    // Function to save settings to localStorage
    function saveSettings(values) {
        localStorage.setItem('refresh_token', values.refreshToken);
        localStorage.setItem('client_id', values.clientId);
        localStorage.setItem('client_secret', values.clientSecret);
        localStorage.setItem('access_token', values.accessToken);
        webix.message("Dropbox Settings saved successfully!");
    }

    // Function to check the validity of the current access token
    async function checkAccessTokenValidity() {
        const accessToken = localStorage.getItem('access_token');
        if (!accessToken) return false;

        try {
            const response = await fetch('https://api.dropboxapi.com/2/files/list_folder', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ path: '' })
            });

            if (response.ok) {
                return true; // Access token is valid
            } else {
                // If the access token is invalid or expired, refresh it
                const { refreshToken, clientId, clientSecret } = loadSettings();
                const newAccessToken = await refreshAccessToken(refreshToken, clientId, clientSecret);
                return !!newAccessToken; // Return true if a new access token is obtained
            }
        } catch (error) {
            console.error('Error checking token validity:', error);
            return false; // Access token is invalid
        }
    }

    // Function to update the token status in the settings window
    async function updateTokenStatus() {
        const isValid = await checkAccessTokenValidity();

        const statusColor = isValid ? "green" : "red";
        document.getElementById("dpAccessStatus").style.backgroundColor = statusColor;

        if(isValid) {
                dbx = new Dropbox.Dropbox({ accessToken: localStorage.getItem('access_token') });
        } 

        const statusElement = $$('tokenStatus'); // Access Webix component by ID
        if (statusElement) {
            const statusMessage = isValid ? "Access Token is valid" : "Access Token is not valid";
            statusElement.setHTML(`<span class='${isValid ? 'valid-status' : 'invalid-status'}'>${statusMessage}</span>`);    

            if(isValid) {
                    $$("saveDropboxSettingsBtn").disable();
            } else {
                    $$("saveDropboxSettingsBtn").enable();
            }                    
 
        } else {
            console.error('Token status element is not rendered.');
        }       

    }



    // Example: Function to refresh the access token
    async function refreshAccessToken(refreshToken, clientId, clientSecret) {
        const url = 'https://api.dropbox.com/oauth2/token';
        const params = new URLSearchParams({
            grant_type: 'refresh_token',
            refresh_token: refreshToken,
            client_id: clientId,
            client_secret: clientSecret
        });

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            });

            const data = await response.json();
            if (data.access_token) {
                localStorage.setItem('access_token', data.access_token); // Store new access token
                updateTokenStatus(); // Update the token status after refreshing
                return data.access_token;
            } else {
                console.error('Failed to refresh access token:', data);
                webix.message({
                    text:"Failed to refresh access token",
                    type:"error", 
                    expire: 10000
                }); 

                return null;
            }
        } catch (error) {
            console.error('Error refreshing access token:', error);
            webix.message({
                text:"Error refreshing access token",
                type:"error", 
                expire: 10000
            }); 

            return null;
        }
    }

    // Open Webix Dropbox access settings window
    function openSettingsWindow() {
        const settings = loadSettings(); // Load current settings from localStorage

        // Webix Window
        webix.ui({
            view: "window",
            id: "dropboxSettingsWindow",
            width: 500,
            height: 350,
            position: "center",
            modal: true,
            head: "Dropbox API Settings",
            body: {
                view: "form",
                id: "settingsForm",
                elements: [
                    { view: "text", label: "Access Token", name: "accessToken", value: settings.accessToken, labelWidth: 150 },
                    { view: "text", label: "Refresh Token", name: "refreshToken", value: settings.refreshToken, labelWidth: 150 },
                    { view: "text", label: "Client ID", name: "clientId", value: settings.clientId, labelWidth: 150 },
                    { view: "text", label: "Client Secret", name: "clientSecret", value: settings.clientSecret, labelWidth: 150, type: "password" },
                    {
                        margin: 5,
                        cols: [
                            { view: "label", label: "Access Status", width: 150 },
                            { view: "template", id: "tokenStatus", template: "<span>Checking token status...</span>", labelWidth: 150, borderless: true }
                        ]
                    },
                    {
                        margin: 5,
                        cols: [
                            { view: "button", id: "saveDropboxSettingsBtn" , value: "Save", css: "webix_primary", click: function() {
                                const values = $$("settingsForm").getValues();
                                saveSettings(values); // Save settings to localStorage
                                updateTokenStatus(); // Check the token status after saving
                            }},
                            { view: "button", value: "Close", click: function() {
                                $$("dropboxSettingsWindow").close(); // Close the settings window
                            }}
                        ]
                    }
                ]
            }
        }).show();

        // Update the token status when the window is shown
        updateTokenStatus();
    }

    // Webix form for Dropbox Access Status
    let dropboxAccessStatus = {
        view: "form",
        css: { "border-radius": "20px" },
        id: "dropboxAccessStatusId",
        elements: [
            {
                cols: [
                    { view: "label", label: "Dropbox Access", width: 120, align: "left" },
                    {
                        view: "label",
                        label: "<span id='dpAccessStatus' style='background-color:none; padding-left:0.5vw;'>&nbsp&nbsp</span>",
                        align: "center",
                        on: {
                            onAfterRender: function() {
                                updateTokenStatus(); // Check the token status when the form is rendered
                            }
                        }
                    }
                ]
            }
        ]
    };




    async function readJsonFile(fileName) {
        try {
            const response = await dbx.filesDownload({ path: '/qna_json_merged' + fileName });
            const blob = response.result.fileBlob || response.result.fileBinary || response.fileBlob || response.fileBinary;

            const reader = new FileReader();

            return new Promise((resolve, reject) => {
                reader.onload = function(event) {
                    try {
                        const json = JSON.parse(event.target.result);
                        resolve(json); // Resolve the promise with the JSON object
                    } catch (error) {
                        reject(error); // Reject the promise in case of error
                    }
                };

                reader.onerror = function() {
                    reject(new Error('FileReader failed')); // Handle file reading errors
                };

                reader.readAsText(blob);
            });
        } catch (error) {
            console.error('Error reading JSON file:', error);
            if (error.status === 401) { // If the token has expired
                const { refreshToken, clientId, clientSecret } = loadSettings();
                const newAccessToken = await refreshAccessToken(refreshToken, clientId, clientSecret);

                if (newAccessToken) {
                    webix.message({
                        text:"Retry read JSON with the new token",
                        expire: 10000
                    });  

                    return readJsonFile(fileName); // Retry with the new token
                }
            }
            throw error; // Re-throw the error to be handled by the caller
        }
    }
    

    async function getJsonData(jsonFilePath) {
        try {
            const jsonObj = await readJsonFile(jsonFilePath);
            return jsonObj; 
        } catch (error) {
            console.error('Error fetching JSON data:', error);
            return null; // Handle the error as needed
        }
    }


    // readJsonFile('/chicka_chicka_boom_boom/chicka_chicka_boom_boom_00.json').then(json => {
    //    console.log(json);
    // });

    //--  var dbx = new Dropbox.Dropbox({ accessToken: ACCESS_TOKEN }); 



    function getPageString(pageNumber) {
        if (pageNumber > 0 && pageNumber < 10) {
            return '0' + (pageNumber - 1).toString();
        } else if (pageNumber >= 10) {
            return (pageNumber - 1).toString();
        } else {
            return null; // Handle invalid page numbers if needed
        }
    }    





    // Function to extract the index value from a single message string e.g.  '{"index":"2-0"'
    function extractIndexValue(message) {
        // Regular expression to capture the index value
        let regex = /"index":"([0-9]+-[0-9]+)"/;   

        let match = message.match(regex); // Find the pattern in the message
        return match ? match[1] : null;  // Return the matched index or null if not found
    }    

    //******************************************************************************************************//   



    /**
    * Function to use with checking output file name, it must start with letter a-z or A-Z
    *
    * @function
    * @memberof HistoJS
    * @since 1.0.0
    * @version 1.0.0
    * @param {*} ch - character to check
    * @returns {boolean} Returns - true or false
    * @example
    *
    * isLetter(3)
    * => false
    *
    * isLetter("A")
    * => true
    *
    * isLetter("$")
    * => false
    */
     
      isLetter = (ch) => {
          return (/[a-zA-Z]/).test(ch)
      } 

  /**
   *  Function to convert datetime string to a Date object
   *
   * @function
   * @memberof Jibo
   * @since 1.0.0
   * @version 1.0.0
   * @param {string} datetimeString
   * @returns {Date object} 
   * @example 
   *
   * parseDatetime( '2020-12-11-17-35-21' )
   * 
   * => Date Fri Dec 11 2020 17:35:21 GMT-0500 (Eastern Standard Time)
   *   
   */ 

    parseDatetime = (datetimeString) => {
      let parts = datetimeString.split('-');
      let year = parseInt(parts[0], 10);
      let month = parseInt(parts[1], 10) - 1; // Month is 0-indexed in JavaScript Date
      let day = parseInt(parts[2], 10);
      let hour = parseInt(parts[3], 10);
      let minute = parseInt(parts[4], 10);
      let second = parseInt(parts[5], 10);
      return new Date(year, month, day, hour, minute, second);
    }



    combineAndSortFiles = (fileContents) => {

        const headerLine = 'Datetime;Event type;Message';
        const firstFileHeader = fileContents[0].split('\n')[0].trim();


        if (firstFileHeader !== headerLine) {
            const secondFileHeader = fileContents[1].split('\n')[0].trim();

            if (secondFileHeader !== headerLine) {
                
                alert('No file is the storybook_event.csv with the correct header');
                return;

            } else {
              // seond file uploaded is the storybook_event.csv
              // This also means  storybook_command.csv file contents uploaded first
              // Swap commands file contents with event contents to make event contents comes first

              let temp = fileContents[0];
              fileContents[0] = fileContents[1];
              fileContents[1] = temp;
            }
        }


        const eventData = Papa.parse(fileContents[0], { header: true, delimiter: ';', skipEmptyLines: true }).data;
        const commandData = Papa.parse(fileContents[1], { header: false, delimiter: ';', skipEmptyLines: true }).data;

        const processedCommandData = commandData.map(row => ({
            "Datetime": row[0],
            "Event type": row[1],
            "Message": row[2]
        }));

        const combinedData = [...eventData, ...processedCommandData];

        // combinedData.sort((a, b) => ( parseDatetime(a.Datetime) >= parseDatetime(b.Datetime) ? 1 : -1 ) );


        combinedData.sort((a, b) => {
            // First, sort by Datetime
            const dateComparison = parseDatetime(a.Datetime) - parseDatetime(b.Datetime);
            
            if (dateComparison !== 0) {
                return dateComparison;
            }

            // // If Datetime is the same, sort based on Event type
            // if (a["Event type"] === "HELLO_WORLD" && b["Event type"] !== "HELLO_WORLD") {
            //     return -1; // a comes first
            // }
            // if (b["Event type"] === "HELLO_WORLD" && a["Event type"] !== "HELLO_WORLD") {
            //     return 1; // b comes first
            // }

            // If Datetime is the same, prioritize "HELLO_WORLD" and "HELLO WORLD MSG"
            if ((a["Event type"] === "HELLO_WORLD" || a["Event type"] === "HELLO WORLD MSG") &&
                (b["Event type"] !== "HELLO_WORLD" && b["Event type"] !== "HELLO WORLD MSG")) {
                return -1; // a comes first
            }
            if ((b["Event type"] === "HELLO_WORLD" || b["Event type"] === "HELLO WORLD MSG") &&
                (a["Event type"] !== "HELLO_WORLD" && a["Event type"] !== "HELLO WORLD MSG")) {
                return 1; // b comes first
            }            

            // Otherwise, keep the original order
            return 0;
        });        

        return combinedData;

    }


  /**
   *  Function to convert time in milliseconds to  HH:MM:SS format
   *
   * @function
   * @memberof Jibo
   * @since 1.0.0
   * @version 1.0.0
   * @param {number} millisecTime
   * @returns {string}   HH:MM:SS format
   * @example 
   *
   * let date1 = parseDatetime('2020-12-11-17-35-21');
   * let date2 = parseDatetime('2020-12-11-17-35-24');
   * let Diff = date2 - date1;
   * => 3000
   *
   * formatTime( 3000 )
   * 
   * => "00:00:03"
   *   
   */ 

    formatTime = (millisecTime) => {
       // Convert milliseconds to hours, minutes, and seconds
      let seconds = Math.floor(millisecTime / 1000);
      let minutes = Math.floor(seconds / 60);
      seconds = seconds % 60;
      let hours = Math.floor(minutes / 60);
      minutes = minutes % 60;

      // Format the millisecTime as HH:MM:SS
      let formattedDifference = [
          hours.toString().padStart(2, '0'),
          minutes.toString().padStart(2, '0'),
          seconds.toString().padStart(2, '0'),
        ].join(':');

      return formattedDifference; 
    }

    
  /**
   *  Function to remove objects with duplicate Datetime values
   *
   * @function
   * @memberof Jibo
   * @since 1.0.0
   * @version 1.0.0
   * @param {Array} objectsArray
   * @returns {Array}   
   * @example 
   *
   * let objectsArr = [
       { id: 1, Datetime: '2020-12-11-17-35-21', name: 'Object A' },
       { id: 2, Datetime: '2020-12-11-17-35-24', name: 'Object B' },
       { id: 3, Datetime: '2020-12-12-17-35-21', name: 'Object C' }, // <<< Duplicate 
       { id: 4, Datetime: '2020-12-12-17-35-21', name: 'Object D' },       
       { id: 5, Datetime: '2020-12-12-17-35-21', name: 'Object E' }
     ];
   *
   * removeDuplicatesByKey( objectsArr, "Datetime" )
   * 
   * => [{ id: 1, Datetime: "2020-12-11-17-35-21", name: "Object A" }, 
         { id: 2, Datetime: "2020-12-11-17-35-24", name: "Object B" },
         { id: 4, Datetime: "2020-12-12-17-35-21", name: "Object C" } ]
   *   
   */ 

    removeDuplicatesByKey = (objectsArray, key2filter) => {
      const seenDatetime = new Set();
      return objectsArray.filter(obj => {
        if (seenDatetime.has(obj[key2filter])) {
          return false; // If datetime has been seen, filter out the object
        } else {
          seenDatetime.add(obj[key2filter]); // Add unseen datetime to the Set
          return true; // Keep the object in the array
        }
      });
    }


    // Function to remove the first encountered object in case of a duplicate datetime
    removeFirstDuplicateByKey = (objectsArray, key2filter) => {
      const seenDatetime = new Set();
      // Reverse the array to ensure the last occurrence is kept
      const reversedObjects = [...objectsArray].reverse();
      const filteredReversedObjects = reversedObjects.filter(obj => {
        if (seenDatetime.has(obj[key2filter])) {
          // If datetime has been seen, filter out this object (which is actually the first one in original order)
          return false;
        } else {
          // Mark this datetime as seen and keep the object (this will remove the first one in original order)
          seenDatetime.add(obj[key2filter]);
          return true;
        }
      });
      // Reverse the array again to restore original order with duplicates removed
      return filteredReversedObjects.reverse();
    }


    function detectDelimiter(text) {
        const lines = text.split('\n').slice(0, 5); // Read only the first 5 lines for detection
        const semicolonCount = lines.reduce((count, line) => count + (line.split(';').length - 1), 0);
        const commaCount = lines.reduce((count, line) => count + (line.split(',').length - 1), 0);
        return semicolonCount > commaCount ? ';' : ',';
    }
 


// Split 'Message' contents such that:
//{ Datetime: "2020-12-11-17-35-02", "Event type": "HELLO_WORLD",    Message: {"needs_download":true,"story_name": [],"last_read_page": [],"tutorial_needed": false,"game_mode": "explore"}}  
//To
//{ Datetime: "2020-12-11-17-35-02", "Event type": "HELLO_WORLD",    Message: '{"needs_download":true', "": null, _1: ' "story_name": []', _2: ' "last_read_page": []', _3: ' "tutorial_needed": false', _4: ' "game_mode": "explore"}' }    

  function transformJsonObject(row) {
      const transformedMessage = {};

      transformedMessage["Datetime"] = row["Datetime"];
      transformedMessage["Event type"] = row["Event type"];

      if( row.Message !== null) {
          let message;
          try {
              message = JSON.parse(row.Message);
          } catch (e) {
              console.error('Error parsing Message:', e);
              return row;
          }


          const keys = Object.keys(message);

          transformedMessage["Message"] = JSON.stringify({[keys[0]]: message[keys[0]]}).slice(1, -1);
          transformedMessage[""] = null;
          for (let i = 1; i < keys.length; i++) {
              transformedMessage[`_${i}`] = JSON.stringify({[keys[i]]: message[keys[i]]}).slice(1, -1);
          }
          
      } else {
          transformedMessage["Message"] = null;
          transformedMessage[""] = null;
          transformedMessage["_1"] = null;
          transformedMessage["_2"] = null;
          transformedMessage["_3"] = null;
          transformedMessage["_4"] = null;
      
      }   
     
      return transformedMessage;
  }


    // Function to transform an array of JSON objects
    function transformJsonArray(arrayOfObj) {
        return arrayOfObj.map(transformJsonObject);
    }


  /**
   *  Convert CSV content to JSON 
   *  Set header true to convert it as json object not as an array 
   *  Set dynamicTyping true to make numbers show as numerical not strings, ex. show as 0 not "0"
   *
   * @function
   * @memberof Jibo
   * @since 1.0.0
   * @version 1.0.0
   * @param {string} csvContent
   * @param {string} delimiter  e.g. ";" or ","  for example 
   * @returns {Array} Array of objects
   * @example 
   *
   *
   *
   * convertCsv2Json( fetchRemoteCsv("./combined104.csv"),  ";" )
   * 
   * => Array(377) [ { Datetime: "2020-12-11-17-35-03", "Event type": "TUTORIAL_COMMAND", Message: '{"tutorial_mode": true', … }, {…}, {…}, {…}, {…}, {…}, {…}, {…}, {…}, {…}, … ]
   *   
   */  

  convertCsv2Json = (csvContent, delimiter) => {
       // header true to convert it as json object not as an array
       // delimiter: "" for Auto-detect delimiter ";" or ","
       return Papa.parse(csvContent, { skipEmptyLines: true, header: true, delimiter: delimiter, dynamicTyping: true}).data;

  }


    /**
    * Fetch csv data from csv file stored locally or remotely  
    *
    * @since 1.0.0
    * @param {string} csvURL 
    * @example
    *
    * fetchRemoteCsv("./combined104.csv")
    *
    */  

    fetchRemoteCsv = (csvURL) => {
        let csvDataObj; 
        $.ajax({
              url: csvURL,
              async: false,
              dataType: 'text',
              success: function (response) {
                csvDataObj = response  
                //-- csvDataObj  'key1, key2
                //--              val1, val2'    
              }
            });

         return csvDataObj ? csvDataObj : null ;

    }


    /**
    * Convert JSON to table  
    *
    * @since 1.0.0
    * @param {object} jsonData 
    * @param {string} tableId
    * @param {bool} enableRank    
    *
    */  

    // Function to convert JSON or CSV data to Webix datatable data with dynamic columns
    function convert2Table(jsonData, tableId, enableRank, adjustType) {
      // Get the Webix datatable
      let datatable = $$(tableId);

      if (datatable) {
        // Show progress overlay
        webix.extend(datatable, webix.ProgressBar);
        datatable.showProgress({
          type: "top"
        });

        // Use setTimeout to simulate a delay for processing the CSV
        setTimeout(function() {
          // Extract column names dynamically from JSON data
          let columns = Object.keys(jsonData[0]).map(key => ({
            id: key,
            header: key,
            adjust: adjustType // "header": Adjust width based on header text,  true: Enable auto width adjustment for columns
          }));


          if(enableRank) {
              // Add the rank column at the beginning
              columns.unshift({
                id: "rank",
                header: "#",
                template: function(obj, common, value, config, index) {
                  return index + 1;
                },
                width: 50
              });
          }          

          // Clear any existing configuration and data
          datatable.clearAll();
          datatable.config.columns = columns;

          // Reconfigure the datatable with new columns and refresh it
          datatable.refreshColumns();

          // Parse the JSON data into the datatable
          datatable.parse(jsonData);

          // Hide progress overlay
          datatable.hideProgress();
        }, 100); // Adjust the delay as needed
      }
    }




  // Function to convert JSON or CSV data to HTML table
   convert2Table_old = (jsonData, containerId) => {

    // Ensure the container is visible and rendered
    webix.ui.$$(containerId).show();

    // Get the container element where the table will be inserted
    let container = $("#" + containerId);

    // Clear any existing content in the container
    container.empty();

    // Create the table element
    let table = $("<table>");

    // Get the keys (column names) of the first object in the JSON data
    let cols = Object.keys(jsonData[0]);

    // Create the header element
    let thead = $("<thead>");
    let tr = $("<tr>");

    // Loop through the column names and create header cells
    $.each(cols, function(i, item) {
      let th = $("<th>");
      th.text(item); // Set the column name as the text of the header cell
      tr.append(th); // Append the header cell to the header row
    });

    thead.append(tr); // Append the header row to the header
    table.append(thead); // Append the header to the table

    // Loop through the JSON data and create table rows
    $.each(jsonData, function(i, item) {
      let tr = $("<tr>");

      // Get the values of the current object in the JSON data
      let vals = Object.values(item);

      // Loop through the values and create table cells
      $.each(vals, function(i, elem) {
        let td = $("<td>");
        td.text(elem); // Set the value as the text of the table cell
        tr.append(td); // Append the table cell to the table row
      });
      table.append(tr); // Append the table row to the table
    });

    container.append(table); // Append the table to the container element
  }


   ////////////////////////////////////////
   ///////////------Mapping-------/////////
  ////////////////////////////////////////


    /**
    * Map raw data to new sheet  
    *
    * @since 1.0.0
    * @param {object} jsonData 
    * @param {string} tableId
    * @param {bool} enableRank    
    *
    */  

   jiboMapping = (rawJsonData, rawStoryBookState, rawJiboState) => {

      console.log("jiboMapping called ......... ")

      
      //-- rawJsonData[0] :{ Datetime: "2020-12-11-17-35-02", "Event type": "HELLO_WORLD", 
      //                     Message: null, "": null, _1: null, _2: null, _3: null, _4: null }      
      
      //-- rawStoryBookState[0] :{ Datetime: "2020-12-11-17-35-29",  audio_playing:  False, audio_file:  "chicka_chicka_boom_boom-01-01.wav",  storybook_mode: "EXPLORE_MODE", page number:  16 }      
      
      //-- rawJiboState[0] :{ Datetime: "2020-12-11-17-41-39",  in_motion: "" , audio:  "",  tts_msg: "Look at all those storybooks!", volume:   "and selecting the book you want to read", led_color: "NO DATA", lookat: NO DATA , doing_motion: True , is_playing_sound: True ,  is_listening: False }


        // To get story titles and thier total page numbers
        let allStoryTitles = [];

        for(let i = 0; i < rawStoryBookState.length; i++) {
           if(rawStoryBookState[i]["audio_file"] != null && rawStoryBookState[i]["audio_file"].includes("-title.wav")) {

               allStoryTitles.push({"audio_file": rawStoryBookState[i]["audio_file"].split("-title.wav")[0], 
                                     "page number" : rawStoryBookState[i]["page number"]  })

           }

        }

        // remove duplicates
        allStoryTitles = removeFirstDuplicateByKey( allStoryTitles, "audio_file" );  
        //-- allStoryTitles ->[ { audio_file: "chicka_chicka_boom_boom", "page number": 16 },
        //                      { audio_file: "farm_animals", "page number": 12 } ]


        // Map total page number of each story
        const totalPageNumberObj = allStoryTitles.reduce((accumulator, current) => {
            accumulator[current.audio_file] = current["page number"];
            return accumulator;
        }, {});

        //-- totalPageNumberObj : {"chicka_chicka_boom_boom" : 16, "farm_animals" : 12,
        //                      "geraldine_the_music_mouse" : 15, "the_little_red_hen-muldrow": 22 };


        // To get story titles and each page and line read.
        let storyBookStatePageLine = [];

        for(let i = 0; i < rawStoryBookState.length; i++) {
        
           if( rawStoryBookState[i]["audio_file"] != null && 
              !rawStoryBookState[i]["audio_file"].includes("-title.wav") &&   
               rawStoryBookState[i]["audio_file"].includes(".wav") ) {

               storyBookStatePageLine.push({
                   "Datetime" : rawStoryBookState[i]["Datetime"],
                   "storyTitle": rawStoryBookState[i]["audio_file"].split(".wav")[0].split("-")[0], 
                   "curPage" :rawStoryBookState[i]["audio_file"].split(".wav")[0].split("-").slice(-2)[0], 
                   "curLine" :rawStoryBookState[i]["audio_file"].split(".wav")[0].split("-").slice(-1)[0] })
           }

        }

        // Remove duplicates date from story page line sheet
        storyBookStatePageLine = removeFirstDuplicateByKey( storyBookStatePageLine, "Datetime" ); 


        getStoryBookObjByDateTime = (dateTime) => {
                let filteredResults = storyBookStatePageLine.filter(obj => obj["Datetime"] === dateTime);
                return filteredResults.length === 0 ? null:  filteredResults[0];
        }


        // To get Jibo states and all Asked question 
        let allJiboTalk = [];
       //-- rawJiboState[0] :{ Datetime: "2020-12-11-17-41-39",  in_motion: "" , audio:  "",  tts_msg: "Look at all those storybooks!", volume:   "and selecting the book you want to read", led_color: "NO DATA", lookat: "NO DATA" , doing_motion: True , is_playing_sound: True ,  is_listening: False }        

        for(let i = 0; i < rawJiboState.length; i++) {
           if(rawJiboState[i]["tts_msg"] != null) {
                // To remove any "<..>" e.g. "<break size=0.2/>"
               let ttsMsg = rawJiboState[i]["tts_msg"].replace(/<[^>]*>/g, '');
               ttsMsg = ttsMsg !== "Sup" ? ttsMsg : "";

               let volMsg = "";
               let ledColorMsg = "";
               let lookAtMsg = ""


               if(rawJiboState[i]["volume"] != null && rawJiboState[i]["volume"] != 0 && rawJiboState[i]["volume"] != "0") {
                   // To remove "Bryson . "  and any "<..>"
                   volMsg = rawJiboState[i]["volume"].replace(/<[^>]*>/g, '').replace(/Bryson \. /g, '');
               }

               if(rawJiboState[i]["led_color"] != null && rawJiboState[i]["led_color"] != "NO DATA" && rawJiboState[i]["led_color"] != 0 && rawJiboState[i]["led_color"] != "0") {

                   ledColorMsg = rawJiboState[i]["led_color"].replace(/<[^>]*>/g, '');
               }


               if(rawJiboState[i]["lookat"] != null && rawJiboState[i]["lookat"] != "NO DATA" && rawJiboState[i]["lookat"] != 0 && rawJiboState[i]["lookat"] != "0") {

                   lookAtMsg = rawJiboState[i]["lookat"].replace(/<[^>]*>/g, '');
               }               

               let jiboTalk =  ttsMsg + volMsg + ledColorMsg + lookAtMsg;
               let isQuestion = jiboTalk.includes("?") ? true : false; 
                
               allJiboTalk.push({"Datetime": rawJiboState[i]["Datetime"] , 
                                          "jiboTalk": jiboTalk, "isQuestion" : isQuestion });

           }

        }

        // remove duplicates
        allJiboTalk = removeFirstDuplicateByKey( allJiboTalk, "Datetime" );  
        //-- allJiboTalk[0] ->{ Datetime: "2020-12-11-18-00-27", jiboTalk: "Give it a try! I believe in you. a farmer uses animals to protect the sheep make wool cloths make milk make meat and so on. That's a lot of animals!", isQuestion: false }
        //  

        getJiboStateObjByDateTime = (dateTime) => {
                let filteredResults = allJiboTalk.filter(obj => obj["Datetime"] === dateTime);
                return filteredResults.length === 0 ? null:  filteredResults[0];
        }


        let rawDataKeys = Object.keys(rawJsonData[0]);
        //-- rawDataKeys : Array(8) [ "Datetime", "Event type", "Message", "", "_1", "_2", "_3", "_4" ]



        newSheetObj = {"Participant" : null, "Datetime" : null, "Date" : null, "Time" : null, 
                      "Storybook Selected" : null, "Total Page Number" : null, "Page Number" : null, 
                      "Line" : null, "Automatic Storytelling vs Selected Storytelling " : "", 
                      "Seconds" : null, "Time Stopes" : "", "Time Reading " : "", "Paused" : "", 
                      "Total Time Reading" : "",  "Total Time Paused" : "", "Total Time in Storybook" : "",  
                      "Tutorial Response" : "",  "Tutorial Command" : "", "NEXT_PAGE Tapped " : "", 
                      "Index/ Line Word Tapped " : "",  "Word Tapped " : "",  "Scene Object Tapped" : "", 
                      "Jibo buttom pressed" : "", "Jibo Asked Question" : "", "Jibo Command" : "",  
                      "Transcription or word/ image tapped " : "",  "No Response to Jibo" : "",  
                      "Confidence level " : "", "Return to library Early" : "", "Finished Storybook" : "",
                       "Student Logout" : "" }



        let cleanDataKeys = Object.keys(newSheetObj);
        //-- rawKeys : Array(31) [ "Participant", "Datetime", "Date", "Time", "Storybook Selected"...]



        // Find HELLO_WORLD indexes, start and end of each session
        let helloWorldStarts = [];
        // e.g. Array(4) [ 0, 21, 27, 206 ]  indices where HELLO_WORLD started

        rawJsonData.forEach((jsonRow, idx) => { // idx starts with 0
        //e.g. jsonRow :  { Datetime: "2020-12-11-17-35-02", "Event type": "HELLO_WORLD", Message: null, "": null, _1: null, _2: null, _3: null, _4: null }

            if(jsonRow["Event type"] === "HELLO_WORLD") {
               helloWorldStarts.push(idx);
            }

        });

        console.log("HELLO_WORLD starts indices : ", helloWorldStarts);



        let helloWorldSessions = [];
        // e.g. Array(4) [ { session: 1, start: 0, end: 20, stories: null },
        //                 { session: 2, start: 21, end: 26, stories: null }, 
        //                 { session: 3, start: 27, end: 205, stories: null },  
        //                 { session: 4, start: 206, end: 376, stories: null } ]    

        // Each session starts with HELLO_WORD and  ends just befor next HELLO_WORLD or by the end of the sheet //.                                                                        


        for (let i = 0; i < helloWorldStarts.length; i++) { // arrIndex starts with 0

            if(i < (helloWorldStarts.length -1) ) {
               helloWorldSessions.push({session: i+1, start: helloWorldStarts[i], end: helloWorldStarts[i+1] - 1, stories: [] });
            } else {
               helloWorldSessions.push({session: i+1, start: helloWorldStarts[i], end: rawJsonData.length - 1, stories: [] });
            }
        };

        console.log("helloWorldSessions :",  helloWorldSessions);

        // e.g. Array(4) [ { session: 1, start: 0, end: 20, stories: null },
        //                 { session: 2, start: 21, end: 26, stories: null }, 
        //                 { session: 3, start: 27, end: 205, stories: null },  
        //                 { session: 4, start: 206, end: 376, stories: null } ]   

        // Each session starts with HELLO_WORD and  ends just befor next HELLO_WORLD or by the end of the sheet //  


        // For STORY_LOAD subsession till next STORY_LOAD within the same HELLO_WORLD session

        helloWorldSessions.forEach((session, idx) => { // idx starts with 0

            let storyLoadSessions = [];
            let storyNames = [];            

            for(let i = session.start; i <= session.end; i++ ) {

               if( rawJsonData[i]["Event type"] === "STORY_LOADED" ) {

                   storyLoadSessions.push({rawSheetIdx: i, Datetime: rawJsonData[i]["Datetime"]})   

               }

               if( rawJsonData[i]["_3"] != null && rawJsonData[i]["_3"].includes("story_name") && !rawJsonData[i]["_3"].includes("[]") ) {
                    
                    let rawStoryName = rawJsonData[i]["_3"].split(":")[1].split("}")[0];
 
                    // test for single quote (') e.g. :  '"chicka_chicka_boom_boom"'
                    if( /['"]/.test( rawStoryName ) ) {  
                        // if true (exist), remove single quote 
                        rawStoryName = rawStoryName.replace(/['"]/g, "")
                        //  '"chicka_chicka_boom_boom"'  ->  "chicka_chicka_boom_boom"
                    }

                    storyNames.push( rawStoryName );
               }               

            }

           session.stories.push({storyName: storyNames, storyLoadSession: storyLoadSessions });

        });


        console.log("helloWorldSessions :",  helloWorldSessions);


      //e.g.  helloWorldSessions[3].stories => Object {storyName: [ '"chicka_chicka_boom_boom"', '"geraldine_the_music_mouse"' ], storyLoadSession: [{ rawSheetIdx: 218, Datetime: "2020-12-28-12-10-13" }, { rawSheetIdx: 330, Datetime: "2020-12-28-12-38-04" }] }



        let newCleanDataSheet = [];

        rawDataKeys.forEach(objKey => {
             console.log(objKey)
        })

        let dateTimeFlag = false;
        let newSheetCounter = 0;
        let storyName = "unknown";

        let pauseStartAt = 0;
        let readStartAt = 0;   

        let totalTimePaused = 0;
        let totalTimeReading = 0; 

        let currentParticipant = "";


        helloWorldSessions.forEach((session, idx) => { // idx starts with 0

            let currentStoryIdx = 0;
            let pageNumber = 1;
            let lineNumber = 1;  
      

            console.log("session.start :", session.start);
            console.log("session.end :", session.end);


            for(let i = session.start; i <= session.end; i++ ) {

                // clone the new Sheet obj
                let newSheetRow = JSON.parse(JSON.stringify(newSheetObj));



                ///////////////////////////////////
                //--------- Add Participant------//
                ///////////////////////////////////

                if( rawJsonData[i]["Event type"] === "HELLO WORLD MSG" ) {

                     if(rawJsonData[i]["Message"].includes("participant_id")){

                         let rawParticipant = rawJsonData[i]["Message"].split(":")[1];
                         // test if  Participant string has single quote ('), if so remove 
                         if( /[' "]/.test(rawParticipant) ) {
                              rawParticipant = rawParticipant.replace(/[' "]/g, "");

                         } else if ( /['"]/.test(rawParticipant) ) {
                              rawParticipant = rawParticipant.replace(/['"]/g, "");
                         }

                         //-- newSheetRow["Participant"] = rawJsonData[i]["Message"].split(":").pop();
                         newSheetRow["Participant"] = rawParticipant;
                         currentParticipant = rawParticipant;

                    }

                } else {

                      if(i != 0 ) {
                         newSheetRow["Participant"] = newCleanDataSheet[i - 1]["Participant"]; 
                      }
                }


                ///////////////////////////////////
                //---- Datetime & Date & time----//
                //----------- Columns -----------//
                ///////////////////////////////////

                newSheetRow["Datetime"] = rawJsonData[i]["Datetime"];

                // Split the string to extract date and time parts
                let [year, month, day, hour24, minute, second] = rawJsonData[i]["Datetime"].split("-");

                // Format the date
                let date = `${year}-${month}-${day}`;

                // Format the time
                let hour = parseInt(hour24, 10);
                let amPm = hour >= 12 ? 'PM' : 'AM';
                // Convert 24-hour time to 12-hour time format
                hour12 = hour % 12;
                hour12 = hour12 ? hour12 : 12; // the hour '0' should be '12'

                // // 12 hours format  
                // -- let time = `${hour12}:${minute}:${second} ${amPm}`;

                // 24 hours format
                let time = `${hour}:${minute}:${second}`;

                newSheetRow["Date"] = date;
                newSheetRow["Time"] = time;

                // newSheetRow["Seconds"] = "00:00:01";
                
                if (i < session.end) {
                   newSheetRow["Seconds"] = formatTime( parseDatetime( rawJsonData[i+1]["Datetime"] ) - parseDatetime( rawJsonData[i]["Datetime"] ) );
                }

                

                ///////////////////////////////////
                //-------Add Selected Story------//
                //-- Storybook Selected Column --//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "HELLO_WORLD") {
                   
                   newSheetRow["Storybook Selected"] = "TUTORIAL";

                } else { // Other then HELLO_WORLD

                   // STORY LOADED -- STORY NAME SHOULD APPEAR WITH "Storybook Selected."
                   if (rawJsonData[i]["Event type"] === "STORY_LOADED") {

                           newSheetRow["Storybook Selected"] = session.stories[0].storyName[currentStoryIdx];

                           // Increment story index to get next story name in that session
                           currentStoryIdx = currentStoryIdx +1;

                   } else {

                       // TUTORIAL MODE
                       if( newCleanDataSheet[i - 1]["Storybook Selected"] === "TUTORIAL" ) {

                               newSheetRow["Storybook Selected"] = "TUTORIAL";

                       } else { // STORY MODE

                               newSheetRow["Storybook Selected"] = newCleanDataSheet[i - 1]["Storybook Selected"]

                       }
                   }                    
                }




                ///////////////////////////////////////////////////////
                //-----------Add Total page, Page & line number------//
                //-----------Automatic  vs Selected Storytelling ----//
                ///////////////////////////////////////////////////////

                if(rawJsonData[i]["Event type"] === "HELLO_WORLD") {
                   
                   newSheetRow["Total Page Number"] = 0; 
                   newSheetRow["Page Number"] = 0; 
                   newSheetRow["Line"] = 0; 
                   newSheetRow["Automatic Storytelling vs Selected Storytelling "] = ""; 

                } else { // Other then HELLO_WORLD

                   // STORY LOADED -- 
                   if (rawJsonData[i]["Event type"] === "STORY_LOADED") {

                           //Reinit story page number and line number with every story loaded
                           pageNumber = 1;
                           lineNumber = 1;

                           newSheetRow["Total Page Number"] = totalPageNumberObj[ newSheetRow["Storybook Selected"] ];  
                           newSheetRow["Page Number"] = pageNumber; 
                           newSheetRow["Line"] = lineNumber;  
                           newSheetRow["Automatic Storytelling vs Selected Storytelling "] = "Automatic";                          

                   } else {

                       // TUTORIAL MODE
                       if( newCleanDataSheet[i - 1]["Storybook Selected"] === "TUTORIAL" ) {

                               newSheetRow["Total Page Number"] = 0;  
                               newSheetRow["Page Number"] = 0;  
                               newSheetRow["Line"] = 0;  
                               newSheetRow["Automatic Storytelling vs Selected Storytelling "] = "";  

                       } else { // STORY MODE

                              let storyPageLineObj = getStoryBookObjByDateTime(rawJsonData[i]["Datetime"]);
                              // -- storyPageLineObj : {Datetime: 2020-12-11-17-59-06, storyTitle:farm_animals , curPage: 2, curLine: 3}

                              if(storyPageLineObj != null) {
                                   lineNumber =  parseInt(storyPageLineObj["curLine"]);
                                   //--pageNumber =  parseInt(storyPageLineObj["curPage"]);
                              } else {
                                 console.log(" No Datetime matching for story page line object")
                              }

                               newSheetRow["Total Page Number"] = totalPageNumberObj[ newSheetRow["Storybook Selected"] ];  
                               newSheetRow["Page Number"] = pageNumber;  
                               newSheetRow["Line"] = lineNumber;  //<<<<<< correct

                               // After "STORY_LOADED" session begin, if tutorial command pressed, assign pause
                               if( (rawJsonData[i]["Event type"] === "TUTORIAL_COMMAND") || 
                                   (rawJsonData[i]["Event type"] === "END_STORY")  ||  
                                   (rawJsonData[i]["Event type"] === "STUDENT_LOGOUT") ) {

                                    newSheetRow["Automatic Storytelling vs Selected Storytelling "] = "Paused";   //<<<<<< correct                       
                               } else {

                                    newSheetRow["Automatic Storytelling vs Selected Storytelling "] = "Automatic";   //<<<<<< correct                       

                                     // newSheetRow["Automatic Storytelling vs Selected Storytelling "] = 
                                     //    newCleanDataSheet[i - 1]["Automatic Storytelling vs Selected Storytelling "];                  
                               }


                       }

                       // increment page num 
                       if (rawJsonData[i]["Event type"] === "NEXT_PAGE") {
                               pageNumber = pageNumber + 1;
                       }

                       // increment line number 
                       // code to add

                   } 

                }



                //////////////////////////////////
                //---------Add Time Stopes------//
                //////////////////////////////////
                                      
                // Check when Automatic  Storytelling  change to paused and stopped, and vice versa                    
                //-- if(newSheetRow["Automatic Storytelling vs Selected Storytelling "] !== "") {
                if(newCleanDataSheet.length > 1) {

                   let prevState = newCleanDataSheet[i - 1]["Automatic Storytelling vs Selected Storytelling "];
                   let currentState = newSheetRow["Automatic Storytelling vs Selected Storytelling "];

                   if(prevState === "") {
                          readStartAt = 0;
                          pauseStartAt = 0;
                          totalTimePaused = 0;
                          totalTimeReading = 0;                          
                   }                    
                   
                   if( ( currentState !== prevState )  ) {
 
                         if(currentState === "Paused") {
                             pauseStartAt  = newSheetRow["Datetime"];
                         }

                         if(currentState === "Automatic") {
                            readStartAt  = newSheetRow["Datetime"];

                         }   

                         if(prevState !== "" &&  currentState !== "") {
                            newSheetRow["Time Stopes"] = newSheetRow["Time"];
                         }                      
                   }

                }



                /////////////////////////////////////////////
                //--------- Time Reading and Paused -------//
                /////////////////////////////////////////////
                                      
                //-- if(newSheetRow["Automatic Storytelling vs Selected Storytelling "] !== "") {

                if(newCleanDataSheet.length > 1) {

                   let prevState =newCleanDataSheet[i - 1]["Automatic Storytelling vs Selected Storytelling "];
                   let currentState = newSheetRow["Automatic Storytelling vs Selected Storytelling "];
                   
                   if( ( currentState !== prevState ) && (prevState !== "" ) ) {
                        
                         if(currentState === "Paused" && readStartAt != 0) {
                             let timeReading = parseDatetime( newSheetRow["Datetime"] ) - parseDatetime( readStartAt );
                             newSheetRow["Time Reading "] = formatTime( timeReading );
                             totalTimeReading = totalTimeReading + timeReading;
                         }

                         if(currentState === "Automatic" && pauseStartAt != 0) {
                            let timePaused = parseDatetime( newSheetRow["Datetime"] ) - parseDatetime( pauseStartAt );
                            newSheetRow["Paused"] = formatTime( timePaused );
                            totalTimePaused = totalTimePaused + timePaused;
                         }  

                         if(currentState === "" && prevState === "Automatic") {
                             let timeReading = parseDatetime( newCleanDataSheet[i - 1]["Datetime"] ) - parseDatetime( readStartAt );
                             newSheetRow["Time Reading "] = formatTime( timeReading );
                             totalTimeReading = totalTimeReading + timeReading;
                             newSheetRow["Total Time Reading"] = formatTime(totalTimeReading);
                             newSheetRow["Total Time Paused"] = formatTime(totalTimePaused);
                             newSheetRow["Total Time in Storybook"] = formatTime(totalTimePaused + totalTimeReading);

                         }

                         if(currentState === "" && prevState === "Paused") {
                            let timePaused = parseDatetime( newCleanDataSheet[i - 1]["Datetime"] ) - parseDatetime( pauseStartAt );
                            newSheetRow["Paused"] = formatTime(timePaused);
                            totalTimePaused = totalTimePaused + timePaused;
                            newSheetRow["Total Time Paused"] = formatTime(totalTimePaused);
                            newSheetRow["Total Time Reading"] = formatTime(totalTimeReading);
                            newSheetRow["Total Time in Storybook"] = formatTime(totalTimePaused + totalTimeReading);
                         }                                                  

                   } 

                }




                ///////////////////////////////////
                //----- Add Tutorial Response ---//
                //-- Tutorial Response Column  --//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "BUTTON_PRESSED") {
                   
                   newSheetRow["Tutorial Response"] = "BUTTON_PRESSED";

                }


                ///////////////////////////////////
                //----- Add Tutorial Command ---//
                //-- Tutorial Command Column  --//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "TUTORIAL_COMMAND") {
                   
                   newSheetRow["Tutorial Command"] = "TUTORIAL_COMMAND";

                }




                ///////////////////////////////////
                //----- Add Next page Command ---//
                //------- Next page Column  -----//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] != null && rawJsonData[i]["Event type"] === "NEXT_PAGE") {
                   
                   newSheetRow["NEXT_PAGE Tapped "] = "NEXT_PAGE";
                }



                /////////////////////////////////////
                //-Index/ Line Word Tapped Column -//
                /////////////////////////////////////

                if(rawJsonData[i]["Event type"] != null && (rawJsonData[i]["Event type"] === "WORD_TAPPED" || 
                   rawJsonData[i]["Event type"] === "HIGHLIGHT_WORD" ) ) { 
                   
                   newSheetRow["Index/ Line Word Tapped "] = rawJsonData[i]["Message"];

                }


                /////////////////////////////////////
                //------ Word Tapped  Column ------//
                /////////////////////////////////////

                if(rawJsonData[i]["_1"] != null && rawJsonData[i]["_1"].includes("word:") ) { 
                   
                   newSheetRow["Word Tapped "] = rawJsonData[i]["_1"];

                }

                // Get the tapped word from dropbox Json file e.g.  
                if( rawJsonData[i]["Event type"] === "WORD_TAPPED" && rawJsonData[i]["Message"].includes('"index"') ) { 

                    // if( allStoryNames.includes( newSheetRow["Storybook Selected"] ) ) {}

                    if(parseInt(newSheetRow["Page Number"]) > 0 ) { 

                       let pageString = getPageString( parseInt(newSheetRow["Page Number"]) );
                       // e.g. '00'


                       let jsonObj = null;

                       let jsonFilePath =  '/' + newSheetRow["Storybook Selected"] + '/' + newSheetRow["Storybook Selected"] + '_' + pageString + '.json';
                       // //-- e.g. '/chicka_chicka_boom_boom/chicka_chicka_boom_boom_00.json'


                        //-- readJsonFile(jsonFilePath).then(jsonResult => {
                        //--    jsonObj = jsonResult;
                        //-- });  

                        jsonObj = getJsonData(jsonFilePath);                          

                        if(jsonObj == null) {
                            console.log("jsonObj is null for this path :", jsonFilePath);

                        } else {

                            let indexRef = extractIndexValue(rawJsonData[i]["Message"]);
                            // e.g.  indexRef  "0-12"  or "2-22"

                            try {

                                // Find the object with the matching index
                                let foundObject = jsonObj["timestamps"].find(obj => obj.index === indexRef);

                                // Check if the object is found and retrieve the associated word
                                if (foundObject) {
                                  newSheetRow["Word Tapped "] =   foundObject.word;
                                  
                                } else {
                                  console.log(`No object found with index "${indexRef}" with "${jsonFilePath}"`);
                                } 
                            } catch(error) {
                                console.log(`Error for object found with index "${indexRef}" and "${jsonFilePath}"`);
                                console.error('Error:', error);

                            }

                        }

                    }

                }

                /////////////////////////////////////
                //--- Scene Object Tapped Column---//
                /////////////////////////////////////

                if(rawJsonData[i]["_1"] != null && rawJsonData[i]["_1"].includes("label:") ) { 
                   
                   newSheetRow["Scene Object Tapped"] = rawJsonData[i]["_1"];

                }



                ///////////////////////////////////
                //--Jibo buttom pressed Column---//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "JIBO_QUESTION_ASKING_ACTIVITY") {
                   
                   newSheetRow["Jibo buttom pressed"] = "JIBO_QUESTION_ASKING_ACTIVITY";

                }



                ///////////////////////////////////
                //--Jibo Asked Question Column---//
                ///////////////////////////////////


                let jiboTalkObj = getJiboStateObjByDateTime(rawJsonData[i]["Datetime"]);
                // -- jiboTalkObj : { Datetime: "2020-12-11-18-05-13", jiboTalk: "What does it mean to reap the wheat? ", isQuestion: true }

                if(jiboTalkObj != null) {

                     newSheetRow["Jibo Asked Question"] = jiboTalkObj["jiboTalk"].replace(/,/g, ";");
                } else {
                   console.log(" No Datetime matching for Jibo state talking object");
                }

                   
   

                ///////////////////////////////////
                //----- Jibo Command Column -----//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "Receive Listen Command") {
                   
                   newSheetRow["Jibo Command"] = "Receive Listen Command";

                }



                //////////////////////////////////////////////////
                //- Transcription or word/ image tapped  Column-//
                //////////////////////////////////////////////////

                // -- /[{}:]/.test(someString) will check if that string has any of the those characers {, }, :

                if(rawJsonData[i]["Message"] !== "NOSPEECH" &&  rawJsonData[i]["Message"] != null &&
                   rawJsonData[i]["Message"] !== "Explore mode" && ! /[{}:]/.test(rawJsonData[i]["Message"])) { 
                   
                   newSheetRow["Transcription or word/ image tapped "] = rawJsonData[i]["Message"];

                }


                ///////////////////////////////////
                //--No Response to Jibo Column --//
                ///////////////////////////////////

                if(rawJsonData[i]["Message"] === "NOSPEECH") {
                   
                   newSheetRow["No Response to Jibo"] = "NOSPEECH";

                }




                ///////////////////////////////////
                //--- Confidence level  Column---//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "?????????????") {     /// <<<<<<<<<
                   
                   newSheetRow["Confidence level "] = "?????";

                }                                




                ///////////////////////////////////
                //-Return to library Early Column-//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "RETURN_TO_LIBRARY_EARLY") {
                   
                   newSheetRow["Return to library Early"] = "RETURN_TO_LIBRARY_EARLY";

                }



                ///////////////////////////////////
                //---Finished Storybook Column---//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "END_STORY") {
                   
                   newSheetRow["Finished Storybook"] = "END_STORY";

                }


                ///////////////////////////////////
                //---Student Logout Column---//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "STUDENT_LOGOUT") {
                   
                   newSheetRow["Student Logout"] = "STUDENT_LOGOUT";

                }



                // Other commands to consider: 
                // END_STORY    ->  can affect page number
                // RETURN_TO_LIBRARY_EARLY ->  can affect page number
                // STUDENT_LOGOUT    ->   can affect page number 



                ///////////////////////////////////
                //----- Add to clean sheet-------//
                ///////////////////////////////////


                newCleanDataSheet.push(newSheetRow);  



            }
            

         });


         //// Remove first duplicates from newCleanDataSheet 
         // newCleanDataSheet = removeFirstDuplicateByKey( newCleanDataSheet, "Datetime" );
 


         // Merging similar Datetime rows
         for( let idx = 1; idx < newCleanDataSheet.length; idx ++) {

            if(newCleanDataSheet[idx]["Datetime"] === newCleanDataSheet[idx - 1]["Datetime"]) {

                 cleanDataKeys.forEach(key => {
                      //--key one of Array(31) [ "Participant", "Datetime", "Date", "Time", ..]
                      if(newCleanDataSheet[idx][key] !== newCleanDataSheet[idx - 1][key] ) {
                               if(newCleanDataSheet[idx][key] == null || newCleanDataSheet[idx][key] === "") {
                                  // since current row cell is empty, and previous row cell is not, copy the value of previous cell into current row cell
                                  newCleanDataSheet[idx][key] = newCleanDataSheet[idx - 1][key];
                               }

                      }

                 })
                 
            }
         }
 

          // Remove deplicate Datetime rows
         for( let idx = 0; idx < newCleanDataSheet.length -1; ) {

            if(newCleanDataSheet[idx + 1]["Datetime"] === newCleanDataSheet[idx]["Datetime"]) {
              
               newCleanDataSheet.splice(idx, 1);
            } else {

               idx =  idx +1;
            }
         }

         //// Remove first duplicates from newCleanDataSheet 
         //-- newCleanDataSheet = removeFirstDuplicateByKey( newCleanDataSheet, "Datetime" );


        $$("fileNameToDL").setValue( currentParticipant + "_" + newCleanDataSheet[0]["Datetime"] + ".csv"); 


        return  newCleanDataSheet;

   }





    /**
    * Map raw data of 3 columns to new sheet  : Datetime, Event type, Message
    *
    * @since 1.0.0
    * @param {object} jsonData 
    * @param {string} tableId
    * @param {bool} enableRank    
    *
    */  

   jiboMapping3col = (rawJsonData, rawStoryBookState, rawJiboState) => {

      console.log("jiboMapping3col called ......... ")
      
      //-- rawJsonData[0] :{ Datetime: "2020-12-11-17-35-02", "Event type": "HELLO_WORLD", 
      //                     Message: null}      
      
      //-- rawStoryBookState[0] :{ Datetime: "2020-12-11-17-35-29",  audio_playing:  False, audio_file:  "chicka_chicka_boom_boom-01-01.wav",  storybook_mode: "EXPLORE_MODE", page number:  16 }      
      
      //-- rawJiboState[0] :{ Datetime: "2020-12-11-17-41-39",  in_motion: "" , audio:  "",  tts_msg: "Look at all those storybooks!", volume:   "and selecting the book you want to read", led_color: "NO DATA", lookat: NO DATA , doing_motion: True , is_playing_sound: True ,  is_listening: False }


        // To get story titles and thier total page numbers
        let allStoryTitles = [];

        for(let i = 0; i < rawStoryBookState.length; i++) {
           if(rawStoryBookState[i]["audio_file"] != null && rawStoryBookState[i]["audio_file"].includes("-title.wav")) {

               allStoryTitles.push({"audio_file": rawStoryBookState[i]["audio_file"].split("-title.wav")[0], 
                                     "page number" : rawStoryBookState[i]["page number"]  })

           }

        }

        // remove duplicates
        allStoryTitles = removeFirstDuplicateByKey( allStoryTitles, "audio_file" );  
        //-- allStoryTitles ->[ { audio_file: "chicka_chicka_boom_boom", "page number": 16 },
        //                      { audio_file: "farm_animals", "page number": 12 } ]


        // Map total page number of each story
        const totalPageNumberObj = allStoryTitles.reduce((accumulator, current) => {
            accumulator[current.audio_file] = current["page number"];
            return accumulator;
        }, {});

        //-- totalPageNumberObj : {"chicka_chicka_boom_boom" : 16, "farm_animals" : 12,
        //                      "geraldine_the_music_mouse" : 15, "the_little_red_hen-muldrow": 22 };


        // To get story titles and each page and line read.
        let storyBookStatePageLine = [];

        for(let i = 0; i < rawStoryBookState.length; i++) {
        
           if( rawStoryBookState[i]["audio_file"] != null && 
              !rawStoryBookState[i]["audio_file"].includes("-title.wav") &&   
               rawStoryBookState[i]["audio_file"].includes(".wav") ) {

               storyBookStatePageLine.push({
                   "Datetime" : rawStoryBookState[i]["Datetime"],
                   "storyTitle": rawStoryBookState[i]["audio_file"].split(".wav")[0].split("-")[0], 
                   "curPage" :rawStoryBookState[i]["audio_file"].split(".wav")[0].split("-").slice(-2)[0], 
                   "curLine" :rawStoryBookState[i]["audio_file"].split(".wav")[0].split("-").slice(-1)[0] })
           }

        }

        // Remove duplicates date from story page line sheet
        storyBookStatePageLine = removeFirstDuplicateByKey( storyBookStatePageLine, "Datetime" ); 


        getStoryBookObjByDateTime = (dateTime) => {
                let filteredResults = storyBookStatePageLine.filter(obj => obj["Datetime"] === dateTime);
                return filteredResults.length === 0 ? null:  filteredResults[0];
        }


        // To get Jibo states and all Asked question 
        let allJiboTalk = [];
       //-- rawJiboState[0] :{ Datetime: "2020-12-11-17-41-39",  in_motion: "" , audio:  "",  tts_msg: "Look at all those storybooks!", volume:   "and selecting the book you want to read", led_color: "NO DATA", lookat: "NO DATA" , doing_motion: True , is_playing_sound: True ,  is_listening: False }        

        for(let i = 0; i < rawJiboState.length; i++) {
           if(rawJiboState[i]["tts_msg"] != null) {
                // To remove any "<..>" e.g. "<break size=0.2/>"
               let ttsMsg = rawJiboState[i]["tts_msg"].replace(/<[^>]*>/g, '');
               ttsMsg = ttsMsg !== "Sup" ? ttsMsg : "";

               let volMsg = "";
               let ledColorMsg = "";
               let lookAtMsg = ""


               if(rawJiboState[i]["volume"] != null && rawJiboState[i]["volume"] != 0 && rawJiboState[i]["volume"] != "0") {
                   // To remove "Bryson . "  and any "<..>"
                   volMsg = rawJiboState[i]["volume"].replace(/<[^>]*>/g, '').replace(/Bryson \. /g, '');
               }

               if(rawJiboState[i]["led_color"] != null && rawJiboState[i]["led_color"] != "NO DATA" && rawJiboState[i]["led_color"] != 0 && rawJiboState[i]["led_color"] != "0") {

                   ledColorMsg = rawJiboState[i]["led_color"].replace(/<[^>]*>/g, '');
               }


               if(rawJiboState[i]["lookat"] != null && rawJiboState[i]["lookat"] != "NO DATA" && rawJiboState[i]["lookat"] != 0 && rawJiboState[i]["lookat"] != "0") {

                   lookAtMsg = rawJiboState[i]["lookat"].replace(/<[^>]*>/g, '');
               }               

               let jiboTalk =  ttsMsg + volMsg + ledColorMsg + lookAtMsg;
               let isQuestion = jiboTalk.includes("?") ? true : false; 
                
               allJiboTalk.push({"Datetime": rawJiboState[i]["Datetime"] , 
                                          "jiboTalk": jiboTalk, "isQuestion" : isQuestion });

           }

        }

        // remove duplicates
        allJiboTalk = removeFirstDuplicateByKey( allJiboTalk, "Datetime" );  
        //-- allJiboTalk[0] ->{ Datetime: "2020-12-11-18-00-27", jiboTalk: "Give it a try! I believe in you. a farmer uses animals to protect the sheep make wool cloths make milk make meat and so on. That's a lot of animals!", isQuestion: false }
        //  

        getJiboStateObjByDateTime = (dateTime) => {
                let filteredResults = allJiboTalk.filter(obj => obj["Datetime"] === dateTime);
                return filteredResults.length === 0 ? null:  filteredResults[0];
        }


        let rawDataKeys = Object.keys(rawJsonData[0]);
        //-- rawDataKeys : Array(3) [ "Datetime", "Event type", "Message"]



        newSheetObj = {"Participant" : null, "Datetime" : null, "Date" : null, "Time" : null, 
                      "Storybook Selected" : null, "Total Page Number" : null, "Page Number" : null, 
                      "Line" : null, "Automatic Storytelling vs Selected Storytelling " : "", 
                      "Seconds" : null, "Time Stopes" : "", "Time Reading " : "", "Paused" : "", 
                      "Total Time Reading" : "",  "Total Time Paused" : "", "Total Time in Storybook" : "",  
                      "Tutorial Response" : "",  "Tutorial Command" : "", "NEXT_PAGE Tapped " : "", 
                      "Index/ Line Word Tapped " : "",  "Word Tapped " : "",  "Scene Object Tapped" : "", 
                      "Jibo buttom pressed" : "", "Jibo Asked Question" : "", "Jibo Command" : "",  
                      "Transcription or word/ image tapped " : "",  "No Response to Jibo" : "",  
                      "Confidence level " : "", "Return to library Early" : "", "Finished Storybook" : "",
                       "Student Logout" : "" }



        let cleanDataKeys = Object.keys(newSheetObj);
        //-- rawKeys : Array(31) [ "Participant", "Datetime", "Date", "Time", "Storybook Selected"...]



        // Find HELLO_WORLD indexes, start and end of each session
        let helloWorldStarts = [];
        // e.g. Array(4) [ 0, 21, 27, 206 ]  indices where HELLO_WORLD started

        rawJsonData.forEach((jsonRow, idx) => { // idx starts with 0
        //e.g. jsonRow :  { Datetime: "2020-12-11-17-35-02", "Event type": "HELLO_WORLD", Message: null }

            if(jsonRow["Event type"] === "HELLO_WORLD") {
               helloWorldStarts.push(idx);
            }

        });

        console.log("HELLO_WORLD starts indices : ", helloWorldStarts);



        let helloWorldSessions = [];
        // e.g. Array(4) [ { session: 1, start: 0, end: 20, stories: null },
        //                 { session: 2, start: 21, end: 26, stories: null }, 
        //                 { session: 3, start: 27, end: 205, stories: null },  
        //                 { session: 4, start: 206, end: 376, stories: null } ]    

        // Each session starts with HELLO_WORD and  ends just befor next HELLO_WORLD or by the end of the sheet //.                                                                        


        for (let i = 0; i < helloWorldStarts.length; i++) { // arrIndex starts with 0

            if(i < (helloWorldStarts.length -1) ) {
               helloWorldSessions.push({session: i+1, start: helloWorldStarts[i], end: helloWorldStarts[i+1] - 1, stories: [] });
            } else {
               helloWorldSessions.push({session: i+1, start: helloWorldStarts[i], end: rawJsonData.length - 1, stories: [] });
            }
        };

        console.log("helloWorldSessions :",  helloWorldSessions);

        // e.g. Array(4) [ { session: 1, start: 0, end: 20, stories: null },
        //                 { session: 2, start: 21, end: 26, stories: null }, 
        //                 { session: 3, start: 27, end: 205, stories: null },  
        //                 { session: 4, start: 206, end: 376, stories: null } ]   

        // Each session starts with HELLO_WORD and  ends just befor next HELLO_WORLD or by the end of the sheet //  


        // For STORY_LOAD subsession till next STORY_LOAD within the same HELLO_WORLD session

        helloWorldSessions.forEach((session, idx) => { // idx starts with 0

            let storyLoadSessions = [];
            let storyNames = [];            

            for(let i = session.start; i <= session.end; i++ ) {

               if( rawJsonData[i]["Event type"] === "STORY_LOADED" ) {

                   storyLoadSessions.push({rawSheetIdx: i, Datetime: rawJsonData[i]["Datetime"]})   

               }

               if( rawJsonData[i]["Message"] != null && rawJsonData[i]["Message"].includes("story_name") && (JSON.parse(rawJsonData[i]["Message"])["story_name"] !== [] ) ) {
                    
                    let rawStoryName = JSON.parse(rawJsonData[i]["Message"])["story_name"];
 
                    // test for single quote (') e.g. :  '"chicka_chicka_boom_boom"'
                    if( /['"]/.test( rawStoryName ) ) {  
                        // if true (exist), remove single quote 
                        rawStoryName = rawStoryName.replace(/['"]/g, "")
                        //  '"chicka_chicka_boom_boom"'  ->  "chicka_chicka_boom_boom"
                    }

                    storyNames.push( rawStoryName );
               }               

            }

           session.stories.push({storyName: storyNames, storyLoadSession: storyLoadSessions });

        });


        console.log("helloWorldSessions :",  helloWorldSessions);


      //e.g.  helloWorldSessions[3].stories => Object {storyName: [ '"chicka_chicka_boom_boom"', '"geraldine_the_music_mouse"' ], storyLoadSession: [{ rawSheetIdx: 218, Datetime: "2020-12-28-12-10-13" }, { rawSheetIdx: 330, Datetime: "2020-12-28-12-38-04" }] }



        let newCleanDataSheet = [];

        rawDataKeys.forEach(objKey => {
             console.log(objKey)
        })

        let dateTimeFlag = false;
        let newSheetCounter = 0;
        let storyName = "unknown";

        let pauseStartAt = 0;
        let readStartAt = 0;   

        let totalTimePaused = 0;
        let totalTimeReading = 0; 

        let currentParticipant = "";


        helloWorldSessions.forEach((session, idx) => { // idx starts with 0

            let currentStoryIdx = 0;
            let pageNumber = 1;
            let lineNumber = 1;  
      

            console.log("session.start :", session.start);
            console.log("session.end :", session.end);


            for(let i = session.start; i <= session.end; i++ ) {

                // clone the new Sheet obj
                let newSheetRow = JSON.parse(JSON.stringify(newSheetObj));



                ///////////////////////////////////
                //--------- Add Participant------//
                ///////////////////////////////////

                if( rawJsonData[i]["Event type"] === "HELLO WORLD MSG" ) {

                     if(rawJsonData[i]["Message"].includes("participant_id")){

                         let rawParticipant = JSON.parse(rawJsonData[i]["Message"])["participant_id"];
                         // test if  Participant string has single quote ('), if so remove 
                         if( /[' "]/.test(rawParticipant) ) {
                              rawParticipant = rawParticipant.replace(/[' "]/g, "");

                         } else if ( /['"]/.test(rawParticipant) ) {
                              rawParticipant = rawParticipant.replace(/['"]/g, "");
                         }

                         //-- newSheetRow["Participant"] = rawJsonData[i]["Message"].split(":").pop();
                         newSheetRow["Participant"] = rawParticipant;
                         currentParticipant = rawParticipant;

                    }

                } else {

                        if (i > 0 && i - 1 < newCleanDataSheet.length && newCleanDataSheet[i - 1] !== undefined) {
                            newSheetRow["Participant"] = newCleanDataSheet[i - 1]["Participant"];
                        }
                            // try {
                            //     if (Array.isArray(newCleanDataSheet) && i > 0 && i - 1 < newCleanDataSheet.length) {
                            //         const previousParticipant = newCleanDataSheet[i - 1];
                            //         if (previousParticipant !== undefined && previousParticipant.Participant !== undefined) {
                            //             newSheetRow["Participant"] = previousParticipant["Participant"];
                            //         }
                            //     }
                            // } catch (error) {
                            //     console.error(`Error at i = ${i}:`, error);
                            // }
                }


                ///////////////////////////////////
                //---- Datetime & Date & time----//
                //----------- Columns -----------//
                ///////////////////////////////////

                newSheetRow["Datetime"] = rawJsonData[i]["Datetime"];

                // Split the string to extract date and time parts
                let [year, month, day, hour24, minute, second] = rawJsonData[i]["Datetime"].split("-");

                // Format the date
                let date = `${year}-${month}-${day}`;

                // Format the time
                let hour = parseInt(hour24, 10);
                let amPm = hour >= 12 ? 'PM' : 'AM';
                // Convert 24-hour time to 12-hour time format
                hour12 = hour % 12;
                hour12 = hour12 ? hour12 : 12; // the hour '0' should be '12'

                // // 12 hours format  
                // -- let time = `${hour12}:${minute}:${second} ${amPm}`;

                // 24 hours format
                let time = `${hour}:${minute}:${second}`;

                newSheetRow["Date"] = date;
                newSheetRow["Time"] = time;

                // newSheetRow["Seconds"] = "00:00:01";
                
                if (i < session.end) {
                   newSheetRow["Seconds"] = formatTime( parseDatetime( rawJsonData[i+1]["Datetime"] ) - parseDatetime( rawJsonData[i]["Datetime"] ) );
                }

                

                ///////////////////////////////////
                //-------Add Selected Story------//
                //-- Storybook Selected Column --//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "HELLO_WORLD") {
                   
                   newSheetRow["Storybook Selected"] = "TUTORIAL";

                } else { // Other then HELLO_WORLD

                   // STORY LOADED -- STORY NAME SHOULD APPEAR WITH "Storybook Selected."
                   if (rawJsonData[i]["Event type"] === "STORY_LOADED" || rawJsonData[i]["Event type"] === "STORY_SELECTED") {

                           newSheetRow["Storybook Selected"] = session.stories[0].storyName[currentStoryIdx];

                           // Increment story index to get next story name in that session
                           currentStoryIdx = currentStoryIdx +1;

                   } else {

                        if (i > 0 && i - 1 < newCleanDataSheet.length && newCleanDataSheet[i - 1] !== undefined) {
                           // TUTORIAL MODE
                           if( newCleanDataSheet[i - 1]["Storybook Selected"] === "TUTORIAL" ) {

                                   newSheetRow["Storybook Selected"] = "TUTORIAL";

                           } else { // STORY MODE

                                   newSheetRow["Storybook Selected"] = newCleanDataSheet[i - 1]["Storybook Selected"]

                           }
                        }   
                   }                    
                }




                ///////////////////////////////////////////////////////
                //-----------Add Total page, Page & line number------//
                //-----------Automatic  vs Selected Storytelling ----//
                ///////////////////////////////////////////////////////

                if(rawJsonData[i]["Event type"] === "HELLO_WORLD") {
                   
                   newSheetRow["Total Page Number"] = 0; 
                   newSheetRow["Page Number"] = 0; 
                   newSheetRow["Line"] = 0; 
                   newSheetRow["Automatic Storytelling vs Selected Storytelling "] = ""; 

                } else { // Other then HELLO_WORLD

                   // STORY LOADED -- 
                   if (rawJsonData[i]["Event type"] === "STORY_LOADED") {

                           //Reinit story page number and line number with every story loaded
                           pageNumber = 1;
                           lineNumber = 1;

                           newSheetRow["Total Page Number"] = totalPageNumberObj[ newSheetRow["Storybook Selected"] ];  
                           newSheetRow["Page Number"] = pageNumber; 
                           newSheetRow["Line"] = lineNumber;  
                           newSheetRow["Automatic Storytelling vs Selected Storytelling "] = "Automatic";                          

                   } else {

                       // TUTORIAL MODE
                       if( newCleanDataSheet[i - 1] !== undefined && newCleanDataSheet[i - 1]["Storybook Selected"] === "TUTORIAL" ) {

                               newSheetRow["Total Page Number"] = 0;  
                               newSheetRow["Page Number"] = 0;  
                               newSheetRow["Line"] = 0;  
                               newSheetRow["Automatic Storytelling vs Selected Storytelling "] = "";  

                       } else { // STORY MODE

                              let storyPageLineObj = getStoryBookObjByDateTime(rawJsonData[i]["Datetime"]);
                              // -- storyPageLineObj : {Datetime: 2020-12-11-17-59-06, storyTitle:farm_animals , curPage: 2, curLine: 3}

                              if(storyPageLineObj != null) {
                                   lineNumber =  parseInt(storyPageLineObj["curLine"]);
                                   //--pageNumber =  parseInt(storyPageLineObj["curPage"]);
                              } else {
                                 console.log(" No Datetime matching for story page line object")
                              }

                               newSheetRow["Total Page Number"] = totalPageNumberObj[ newSheetRow["Storybook Selected"] ];  
                               newSheetRow["Page Number"] = pageNumber;  
                               newSheetRow["Line"] = lineNumber;  //<<<<<< correct

                               // After "STORY_LOADED" session begin, if tutorial command pressed, assign pause
                               if( (rawJsonData[i]["Event type"] === "TUTORIAL_COMMAND") || 
                                   (rawJsonData[i]["Event type"] === "END_STORY")  ||  
                                   (rawJsonData[i]["Event type"] === "STUDENT_LOGOUT") ) {

                                    newSheetRow["Automatic Storytelling vs Selected Storytelling "] = "Paused";   //<<<<<< correct                       
                               } else {

                                    newSheetRow["Automatic Storytelling vs Selected Storytelling "] = "Automatic";   //<<<<<< correct                       

                                     // newSheetRow["Automatic Storytelling vs Selected Storytelling "] = 
                                     //    newCleanDataSheet[i - 1]["Automatic Storytelling vs Selected Storytelling "];                  
                               }


                       }

                       // increment page num 
                       if (rawJsonData[i]["Event type"] === "NEXT_PAGE") {
                               pageNumber = pageNumber + 1;
                       }

                       // increment line number 
                       // code to add

                   } 

                }



                //////////////////////////////////
                //---------Add Time Stopes------//
                //////////////////////////////////
                                      
                // Check when Automatic  Storytelling  change to paused and stopped, and vice versa                    
                //-- if(newSheetRow["Automatic Storytelling vs Selected Storytelling "] !== "") {
                if(newCleanDataSheet.length > 1 ) {

                   let prevState = newCleanDataSheet[i - 1] !== undefined ? newCleanDataSheet[i - 1]["Automatic Storytelling vs Selected Storytelling "] : "";
                   let currentState = newSheetRow["Automatic Storytelling vs Selected Storytelling "];

                   if(prevState === "") {
                          readStartAt = 0;
                          pauseStartAt = 0;
                          totalTimePaused = 0;
                          totalTimeReading = 0;                          
                   }                    
                   
                   if( ( currentState !== prevState )  ) {
 
                         if(currentState === "Paused") {
                             pauseStartAt  = newSheetRow["Datetime"];
                         }

                         if(currentState === "Automatic") {
                            readStartAt  = newSheetRow["Datetime"];

                         }   

                         if(prevState !== "" &&  currentState !== "") {
                            newSheetRow["Time Stopes"] = newSheetRow["Time"];
                         }                      
                   }

                }



                /////////////////////////////////////////////
                //--------- Time Reading and Paused -------//
                /////////////////////////////////////////////
                                      
                //-- if(newSheetRow["Automatic Storytelling vs Selected Storytelling "] !== "") {

                if(newCleanDataSheet.length > 1) {

                   let prevState = newCleanDataSheet[i - 1] !== undefined ? newCleanDataSheet[i - 1]["Automatic Storytelling vs Selected Storytelling "] : "";
                   let currentState = newSheetRow["Automatic Storytelling vs Selected Storytelling "];
                   
                   if( ( currentState !== prevState ) && (prevState !== "" ) ) {
                        
                         if(currentState === "Paused" && readStartAt != 0) {
                             let timeReading = parseDatetime( newSheetRow["Datetime"] ) - parseDatetime( readStartAt );
                             newSheetRow["Time Reading "] = formatTime( timeReading );
                             totalTimeReading = totalTimeReading + timeReading;
                         }

                         if(currentState === "Automatic" && pauseStartAt != 0) {
                            let timePaused = parseDatetime( newSheetRow["Datetime"] ) - parseDatetime( pauseStartAt );
                            newSheetRow["Paused"] = formatTime( timePaused );
                            totalTimePaused = totalTimePaused + timePaused;
                         }  

                         if(currentState === "" && prevState === "Automatic") {
                             let timeReading = parseDatetime( newCleanDataSheet[i - 1]["Datetime"] ) - parseDatetime( readStartAt );
                             newSheetRow["Time Reading "] = formatTime( timeReading );
                             totalTimeReading = totalTimeReading + timeReading;
                             newSheetRow["Total Time Reading"] = formatTime(totalTimeReading);
                             newSheetRow["Total Time Paused"] = formatTime(totalTimePaused);
                             newSheetRow["Total Time in Storybook"] = formatTime(totalTimePaused + totalTimeReading);

                         }

                         if(currentState === "" && prevState === "Paused") {
                            let timePaused = parseDatetime( newCleanDataSheet[i - 1]["Datetime"] ) - parseDatetime( pauseStartAt );
                            newSheetRow["Paused"] = formatTime(timePaused);
                            totalTimePaused = totalTimePaused + timePaused;
                            newSheetRow["Total Time Paused"] = formatTime(totalTimePaused);
                            newSheetRow["Total Time Reading"] = formatTime(totalTimeReading);
                            newSheetRow["Total Time in Storybook"] = formatTime(totalTimePaused + totalTimeReading);
                         }                                                  

                   } 

                }




                ///////////////////////////////////
                //----- Add Tutorial Response ---//
                //-- Tutorial Response Column  --//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "BUTTON_PRESSED") {
                   
                   newSheetRow["Tutorial Response"] = "BUTTON_PRESSED";

                }


                ///////////////////////////////////
                //----- Add Tutorial Command ---//
                //-- Tutorial Command Column  --//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "TUTORIAL_COMMAND") {
                   
                   newSheetRow["Tutorial Command"] = "TUTORIAL_COMMAND";

                }




                ///////////////////////////////////
                //----- Add Next page Command ---//
                //------- Next page Column  -----//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] != null && rawJsonData[i]["Event type"] === "NEXT_PAGE") {
                   
                   newSheetRow["NEXT_PAGE Tapped "] = "NEXT_PAGE";
                }



                /////////////////////////////////////
                //-Index/ Line Word Tapped Column -//
                /////////////////////////////////////

                if(rawJsonData[i]["Event type"] != null && rawJsonData[i]["Event type"] === "WORD_TAPPED" ) { 
                   
                   newSheetRow["Index/ Line Word Tapped "] = '"index":' + JSON.parse(rawJsonData[i]["Message"])["index"]

                   

                }


                if(rawJsonData[i]["Event type"] != null && rawJsonData[i]["Event type"] === "HIGHLIGHT_WORD"  ) { 
                   
                   newSheetRow["Index/ Line Word Tapped "] = '"indexes":' + JSON.parse(rawJsonData[i]["Message"])["indexes"]
                   newSheetRow["Index/ Line Word Tapped "] = newSheetRow["Index/ Line Word Tapped "].replace(/,/g, ";");

                }

                /////////////////////////////////////
                //------ Word Tapped  Column ------//
                /////////////////////////////////////

                if(rawJsonData[i]["Message"] != null && rawJsonData[i]["Message"].includes("word:") ) { 
                   
                   newSheetRow["Word Tapped "] = JSON.parse(rawJsonData[i]["Message"])["word"];

                }


                // Get the tapped word from dropbox Json file e.g.  
                if( rawJsonData[i]["Event type"] === "WORD_TAPPED" && rawJsonData[i]["Message"].includes('"index"') ) { 

                    //-- if( allStoryNames.includes( newSheetRow["Storybook Selected"] ) ) {}

                    if(parseInt(newSheetRow["Page Number"]) > 0 ) { 

                       let pageString = getPageString( parseInt(newSheetRow["Page Number"]) );
                       // e.g. '00'


                       let jsonObj = null;

                       let jsonFilePath =  '/' + newSheetRow["Storybook Selected"] + '/' + newSheetRow["Storybook Selected"] + '_' + pageString + '.json';
                       // //-- e.g. '/chicka_chicka_boom_boom/chicka_chicka_boom_boom_00.json'                       
                       
                        jsonObj = getJsonData(jsonFilePath); 

                        if(jsonObj == null) {
                            console.log("jsonObj is null for this path :", jsonFilePath);

                        } else {

                            let indexRef = JSON.parse(rawJsonData[i]["Message"])["index"];
                            // e.g.  indexRef  "0-12"  or "2-22"

                            try {

                                // Find the object with the matching index
                                let foundObject = jsonObj["timestamps"].find(obj => obj.index === indexRef);

                                // Check if the object is found and retrieve the associated word
                                if (foundObject) {
                                  newSheetRow["Word Tapped "] =   foundObject.word;
                                  
                                } else {
                                  console.log(`No object found with index "${indexRef}" with "${jsonFilePath}"`);
                                } 
                            } catch(error) {
                                console.log(`Error for object found with index "${indexRef}" and "${jsonFilePath}"`);
                                console.error('Error:', error);

                            }

                        }                                                 

                    }

                }


                /////////////////////////////////////
                //--- Scene Object Tapped Column---//
                /////////////////////////////////////

                if(rawJsonData[i]["Message"] != null && rawJsonData[i]["Message"].includes("label:") ) { 
                   
                   newSheetRow["Scene Object Tapped"] = JSON.parse(rawJsonData[i]["Message"])["label"];

                }



                ///////////////////////////////////
                //--Jibo buttom pressed Column---//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "JIBO_QUESTION_ASKING_ACTIVITY") {
                   
                   newSheetRow["Jibo buttom pressed"] = "JIBO_QUESTION_ASKING_ACTIVITY";

                }



                ///////////////////////////////////
                //--Jibo Asked Question Column---//
                ///////////////////////////////////


                let jiboTalkObj = getJiboStateObjByDateTime(rawJsonData[i]["Datetime"]);
                // -- jiboTalkObj : { Datetime: "2020-12-11-18-05-13", jiboTalk: "What does it mean to reap the wheat? ", isQuestion: true }

                if(jiboTalkObj != null) {

                     newSheetRow["Jibo Asked Question"] = jiboTalkObj["jiboTalk"].replace(/,/g, ";");
                } else {
                   console.log(" No Datetime matching for Jibo state talking object")
                }

                   
   

                ///////////////////////////////////
                //----- Jibo Command Column -----//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "Receive Listen Command") {
                   
                   newSheetRow["Jibo Command"] = "Receive Listen Command";

                }



                //////////////////////////////////////////////////
                //- Transcription or word/ image tapped  Column-//
                //////////////////////////////////////////////////

                // -- /[{}:]/.test(someString) will check if that string has any of the those characers {, }, :

                if(rawJsonData[i]["Message"] !== "NOSPEECH" &&  rawJsonData[i]["Message"] != null &&
                   !rawJsonData[i]["Message"].includes("Explore mode") && ! /[{}:]/.test(rawJsonData[i]["Message"])) { 
                   
                   newSheetRow["Transcription or word/ image tapped "] = rawJsonData[i]["Message"];

                }


                ///////////////////////////////////
                //--No Response to Jibo Column --//
                ///////////////////////////////////

                if(rawJsonData[i]["Message"] === "NOSPEECH" || rawJsonData[i]["Message"].includes("NOSPEECH") ) {
                   
                   newSheetRow["No Response to Jibo"] = "NOSPEECH";

                }




                ///////////////////////////////////
                //--- Confidence level  Column---//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "?????????????") {     /// <<<<<<<<<
                   
                   newSheetRow["Confidence level "] = "?????";

                }                                




                ///////////////////////////////////
                //-Return to library Early Column-//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "RETURN_TO_LIBRARY_EARLY") {
                   
                   newSheetRow["Return to library Early"] = "RETURN_TO_LIBRARY_EARLY";

                }



                ///////////////////////////////////
                //---Finished Storybook Column---//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "END_STORY") {
                   
                   newSheetRow["Finished Storybook"] = "END_STORY";

                }


                ///////////////////////////////////
                //---Student Logout Column---//
                ///////////////////////////////////

                if(rawJsonData[i]["Event type"] === "STUDENT_LOGOUT") {
                   
                   newSheetRow["Student Logout"] = "STUDENT_LOGOUT";

                }



                // Other commands to consider: 
                // END_STORY    ->  can affect page number
                // RETURN_TO_LIBRARY_EARLY ->  can affect page number
                // STUDENT_LOGOUT    ->   can affect page number 



                ///////////////////////////////////
                //----- Add to clean sheet-------//
                ///////////////////////////////////


                newCleanDataSheet.push(newSheetRow);  



            }
            

         });


         //// Remove first duplicates from newCleanDataSheet 
         // newCleanDataSheet = removeFirstDuplicateByKey( newCleanDataSheet, "Datetime" );
 


         // Merging similar Datetime rows
         for( let idx = 1; idx < newCleanDataSheet.length; idx ++) {

            if(newCleanDataSheet[idx]["Datetime"] === newCleanDataSheet[idx - 1]["Datetime"]) {

                 cleanDataKeys.forEach(key => {
                      //--key one of Array(31) [ "Participant", "Datetime", "Date", "Time", ..]
                      if(newCleanDataSheet[idx][key] !== newCleanDataSheet[idx - 1][key] ) {
                               if(newCleanDataSheet[idx][key] == null || newCleanDataSheet[idx][key] === "") {
                                  // since current row cell is empty, and previous row cell is not, copy the value of previous cell into current row cell
                                  newCleanDataSheet[idx][key] = newCleanDataSheet[idx - 1][key];
                               }

                      }

                 })
                 
            }
         }
 

          // Remove deplicate Datetime rows
         for( let idx = 0; idx < newCleanDataSheet.length -1; ) {

            if(newCleanDataSheet[idx + 1]["Datetime"] === newCleanDataSheet[idx]["Datetime"]) {
              
               newCleanDataSheet.splice(idx, 1);
            } else {

               idx =  idx +1;
            }
         }

         //// Remove first duplicates from newCleanDataSheet 
         //-- newCleanDataSheet = removeFirstDuplicateByKey( newCleanDataSheet, "Datetime" );


        // List of fields to check for empty values
        const fieldsToCheck = [
          "Time Stopes", "Time Reading ", "Paused", 
          "Total Time Reading", "Total Time Paused", "Total Time in Storybook",  
          "Tutorial Response", "Tutorial Command", "NEXT_PAGE Tapped ", 
          "Index/ Line Word Tapped ", "Word Tapped ", "Scene Object Tapped", 
          "Jibo buttom pressed", "Jibo Asked Question", "Jibo Command",  
          "Transcription or word/ image tapped ", "No Response to Jibo",  
          "Confidence level ", "Return to library Early", "Finished Storybook",
          "Student Logout"
        ];

        // Filter out objects where any of the specified fields are empty
        const filteredData = newCleanDataSheet.filter(item => {
          // Check if all the specified fields have non-empty values
         
          return fieldsToCheck.some(field => item[field] !== "" && item[field] !== null);
        });      


        console.log(" filteredData :", filteredData)   


        $$("fileNameToDL").setValue( currentParticipant + "_" + newCleanDataSheet[0]["Datetime"] + ".csv"); 

        if(true) { // if removing empty rows with fields of check is true..

            return  filteredData;

        }    

        console.log(" newCleanDataSheet :", newCleanDataSheet)

        return  newCleanDataSheet;

   }


    ///////////////////////////////////////
    //////////--------WEBIX------//////////
    ///////////////////////////////////////

    webix.ready(function () {

      //  Main Parameters
      let jiboStateFolderPath = "jibo_state/";
      let storybookStateFolderPath = "storybook_state/";

 


      // Enable/disable ranking column for tables rows
      let enableRankFlag = false;
      
      // For lage csv like storybookState and jiboState
      let enableDataSampling = false;
      let numOfSamples = 10;

      let swTimeOut = 1000;   

      let rawCsvFileNames = [];
      //--rawCsvFileNames : Array [ "storybook_event.csv", "storybook_command.csv" ]
      rawCsvFileContents = [];

      let StorybookStateFileName = '';
      let jiboStateFileName = '';

      rawJsonData = [];
      //-- rawJsonData[0] :{ Datetime: "2020-12-11-17-35-02", "Event type": "HELLO_WORLD", 
      //                     Message: null, "": null, _1: null, _2: null, _3: null, _4: null }      
      let rawStoryBookState = [];
      //-- rawStoryBookState[0] :{ Datetime: "2020-12-11-17-35-29",  audio_playing:  False, audio_file:  "chicka_chicka_boom_boom-01-01.wav",  storybook_mode: "EXPLORE_MODE", page number:  16 }      
      let rawJiboState = [];
      //-- rawJiboState[0] :{ Datetime: "2020-12-11-17-41-39",  in_motion: "" , audio:  "",  tts_msg: "Look at all those storybooks!", volume:   "and selecting the book you want to read", led_color: "NO DATA", lookat: NO DATA , doing_motion: True , is_playing_sound: True ,  is_listening: False }

      let newCleanCSVSheet = [];

      checkAllUpload = () => {
          return rawJsonData.length && rawStoryBookState.length && rawJiboState.length ? true : false;
      }
      

      let about = "Demo of Jibo mapping";
      aboutClick = () => {
          webix.alert({
            title:"",
            ok:"Ok",
            text: about
          })
      }



      toolbar = {
        view: "toolbar",
        id: "myToolbar",
        rows:[{ cols: [
          { view: "label", label: "JIBO&nbsp;MAPPING", css: {"margin":"0!important"},  inputWidth: 100, align: "left" }, 
          { template: "<i class='fas fa-cog fa-settings'></i>", borderless: true, width: 40, onClick: {
            "fa-cog": function() {
                openSettingsWindow();  // Open the settings window on click
             }
          }},

          { view: "button", id: "About", value: "About", width: 100, align: "right", click: aboutClick }
        ]}
       ]
      }


      let rawCsvFile = {view: "form", css: {"border-radius": "20px"},  elements: [ 
                         { type:"header", template:"Load Raw CSV"},
                         {cols: [ 
                           {  view: "label", label: "Select File",  
                              align: "left"
                           }, 
                          { 
                           view: "uploader" , value: "Browse", width: 100, id:"rawCsvUploader",
                           align: "left",
                           accept: "text/csv",
                           autosend: false, 
                           multiple: true, 
                           on: {        
                                onBeforeFileAdd: function(upload) {        
                                  let file = upload.file;
                                  //File { name: "combined104.csv", lastModified: 1704578818136, webkitRelativePath: "", size: 31419, type: "text/csv" }

                                  rawCsvFileNames.push(file.name);
                                  //--rawCsvFileNames: Array["storybook_event.csv", "storybook_command.csv"]
                                  //--OR
                                  //--rawCsvFileNames : Array["combined104.csv"]

                                  let reader = new FileReader();  

                                  reader.onloadend = function(event) {

                                      if (event.target.readyState === FileReader.DONE) {

                                          rawCsvFileContents.push(event.target.result);

                                          if (rawCsvFileContents.length === 2) { 
                                          // 2 files are selected "storybook_event.csv", "storybook_command.csv"

                                              if(rawCsvFileNames[0] === "storybook_event.csv" && 
                                                 rawCsvFileNames[1] === "storybook_command.csv") {

                                                   console.log("Correct file orders");
                                                   rawJsonData = combineAndSortFiles(rawCsvFileContents);
                                                  

                                              } else if(rawCsvFileNames[1] === "storybook_event.csv" &&
                                                        rawCsvFileNames[0] === "storybook_command.csv") {

                                                         console.log("Incorrect files orders, needs swaping");

                                                         // Swap names
                                                         let tempName = rawCsvFileNames[0];
                                                         rawCsvFileNames[0] = rawCsvFileNames[1]
                                                         rawCsvFileNames[1] = tempName;

                                                         //Swap contents
                                                         let tempContents = rawCsvFileContents[0];
                                                         rawCsvFileContents[0] = rawCsvFileContents[1];
                                                         rawCsvFileContents[1] = tempContents;

                                                         rawJsonData = combineAndSortFiles(rawCsvFileContents);

                                              } else {
                                                    alert('Please select 2 files: storybook_event.csv and storybook_command.csv');
                                                    return;
                                              }
                                              

                                          } 

                                          if (rawCsvFileContents.length === 1) { // one csv file e.g. combine104.csv

                                               if(rawCsvFileNames[0] !== "storybook_event.csv" && rawCsvFileNames[0] !== "storybook_command.csv") {

                                                   const delimiter = detectDelimiter(event.target.result);

                                                   // Convert CSV data to JSON
                                                   rawJsonData = convertCsv2Json(event.target.result, delimiter); 
                                                   console.log(event.target.result)
                                                   console.log(" test here ------")
                                                   console.log("rawJsonData :", rawJsonData)
                                                   //-- rawJsonData[0] :{ Datetime: "2020-12-11-17-35-02", "Event type": "HELLO_WORLD",    Message: null, "": null, _1: null, _2: null, _3: null, _4: null }  

                                                   
                                                   // if "Message" need split  
                                                   if(Object.keys(rawJsonData[0]).length == 3) {
                                                      // Transform the JSON array
                                                      // rawJsonData = transformJsonArray(rawJsonData);
                                                   }  
                                               }  else {

                                                       return;
                                               }

                                          } 

                                          // if rawJsonData found from uploaded file/s
                                          if( ( Object.keys(rawJsonData[0]).length >= 3 ) && 
                                              (rawJsonData.length > 1)  ) {

                                                 webix.message({
                                                    text: rawCsvFileNames + " uploaded.",
                                                    expire: 5000, // time in milliseconds after which the message will disappear
                                                    type: "info",
                                                    css: "my-popup"
                                                 });              

                                                 // Open  RAW CSV tab 
                                                 // $$("tabview").setValue("rawCsvTab");

                                                 $$("rawCsvUploader").disable();                                         
                                                 // Draw table with Raw tab for visualization 
                                                 convert2Table(JSON.parse(JSON.stringify(rawJsonData)), "rawCsvTableId", enableRankFlag,true);

                                              
                                                 // Check if all needed CSV fils uploaded 
                                                 if(checkAllUpload()) {
                                                       $$("convertBtn").enable();
                                                 }  

                                          } else {
                                                    alert('No valid raw csv file/files uploaded ...');
                                                    return;
                                          }
                                      }
                                  };

                                  reader.readAsText(file);
                                  return false;
                               }
                              }
                          },

                        ]} 

      ]}
 

      let storybookStateFile = {view: "form", css: {"border-radius": "20px"},  elements: [ 
                         { type:"header", template:"Load Storybook State"},
                         {cols: [ 
                           {  view: "label", label: "Select File",  
                              align: "left"
                           }, 
                          { 
                           view: "uploader" , value: "Browse", width: 100, id:"storyStateCsvUploader",
                           align: "left",
                           accept: "text/csv",
                           autosend: false, 
                           multiple: false, 
                           on: {        
                                onBeforeFileAdd: function(upload) {        
                                  let file = upload.file;
                                  StorybookStateFileName = file;
                                  //file { name: "c201_0_storybook_Combined.csv", lastModified: 1548792883000, webkitRelativePath: "", size: 503010, type: "text/csv" }
                                 // StorybookStateFileName['name']= "c201_0_storybook_Combined.csv"

                                  let reader = new FileReader();  
                                  reader.onloadend = function(event) {

                                      if (event.target.readyState === FileReader.DONE) {

                                            // Check the header of the file
                                            const expectedHeader1 = "Datetime;audio_playing;audio_file;storybook_mode;page number";
                                            const expectedHeader2 = "Datetime,audio_playing,audio_file,storybook_mode,page number";                                            
                                            const fileHeader = event.target.result.split('\n')[0].trim();

                                          
                                            if (fileHeader.includes(expectedHeader1) ||  fileHeader.includes(expectedHeader2) ) {

                                                 const delimiter = detectDelimiter(event.target.result);

                                                 // Convert CSV data to JSON
                                                 rawStoryBookState = convertCsv2Json(event.target.result, delimiter); 
                                                 //-- rawStoryBookState[0] :{ Datetime: "2020-12-11-17-35-29",  audio_playing:  False, audio_file:  "chicka_chicka_boom_boom-01-01.wav",  storybook_mode: "EXPLORE_MODE", page number:  16 }                                         

                                                 webix.message({
                                                    text: file['name'] + " loaded.",
                                                    expire: 5000, // time in milliseconds after which the message will disappear
                                                    type: "info",
                                                    css: "my-popup"
                                                 });

                                                 // Open  STORY STATE SAMPLE tab 
                                                 // $$("tabview").setValue("storyStateSampleTab");

            
                                                 $$("storyStateCsvUploader").disable();

                                                 // Tabulate CSV data with Raw tab for visualization 
                                                 if(enableDataSampling) {
                                                     convert2Table(JSON.parse(JSON.stringify(rawStoryBookState.slice(0, numOfSamples) )), "storyStateTableId", enableRankFlag, true);
                                                 } else {
                                                     // Tabulate  all CSV data 
                                                     convert2Table(JSON.parse(JSON.stringify(rawStoryBookState)), "storyStateTableId", enableRankFlag, "header");
                                                 }



                                                 // Check if all needed CSV fils uploaded
                                                 if(checkAllUpload()) {
                                                       $$("convertBtn").enable();
                                                 }
                                            } else {

                                                 alert('Incorrect file uploaded. Please upload the correct storybook state CSV file (e.g. storybook_state.csv).');
                                            }

                                      }
                                  };

                                  reader.readAsText(file);
                                  return false;
                               }
                              }
                          },

                        ]} 

      ]}

      let jiboStateFile = {view: "form", css: {"border-radius": "20px"},  elements: [ 
                         { type:"header", template:"Load Jibo State"},


                         {rows: [ 
                                  { view: "switch", label: "Remove Duplicate",  
                                    offLabel: "Off", 
                                    onLabel: "On", 
                                    value: 0, 
                                    labelWidth:130, 
                                    id: "removeDuplicatesBtn", 
                                    align: "left"
                                  }
                               ]
                         }, 

                         {cols: [ 
                           {  view: "label", label: "Select File",  
                              align: "left"
                           }, 
                          { 
                           view: "uploader" , value: "Browse", width: 100, id:"jiboStateCsvUploader",
                           align: "left",
                           accept: "text/csv",
                           autosend: false, 
                           multiple: false, 
                           on: {        
                                onBeforeFileAdd: function(upload) {        
                                  let file = upload.file;
                                  jiboStateFileName = file;
                                  //file { name: "c201_0_jibostate_Combined.csv", lastModified: 1548792883000, webkitRelativePath: "", size: 503010, type: "text/csv" }
                                 // file['name']= "c201_0_jibostate_Combined.csv"

                                  let reader = new FileReader();  
                                  reader.onloadend = function(event) {

                                      if (event.target.readyState === FileReader.DONE) {

                                          // Check the header of the file
                                          const expectedHeader1 = "Datetime;in_motion;audio;tts_msg;volume;led_color;lookat;doing_motion;is_playing_sound;is_listening";
                                          const expectedHeader2 = "Datetime,in_motion,audio,tts_msg,volume,led_color,lookat,doing_motion,is_playing_sound,is_listening";                                          
                                          const fileHeader = event.target.result.split('\n')[0].trim();

                                          if (fileHeader.includes(expectedHeader1) ||  fileHeader.includes(expectedHeader2) ) {
                                          
                                               const delimiter = detectDelimiter(event.target.result);

                                               // Convert CSV data to JSON
                                               rawJiboState = convertCsv2Json(event.target.result, delimiter); 
                                               //-- rawJiboState[0] :{ Datetime: "2020-12-11-17-41-39",  in_motion: "" , audio:  "",  tts_msg: "Look at all those storybooks!", volume:   "and selecting the book you want to read", led_color: "NO DATA", lookat: NO DATA , doing_motion: True , is_playing_sound: True ,  is_listening: False }

                                              if($$("removeDuplicatesBtn").getValue()) {
                                                  // Filter duplicates
                                                  let filteredJiboState = [];
                                                  let seen = new Set();

                                                  rawJiboState.forEach(item => {
                                                      // Create a unique identifier based on the content of the other columns
                                                      let identifier = `${item.in_motion}|${item.audio}|${item.tts_msg}|${item.volume}|${item.led_color}|${item.lookat}|${item.doing_motion}|${item.is_playing_sound}|${item.is_listening}`;

                                                      if (!seen.has(identifier)) {
                                                          filteredJiboState.push(item);
                                                          seen.add(identifier);
                                                      }
                                                   });    

                                                   rawJiboState = filteredJiboState;                                              

                                              } 

                                          

                                               webix.message({
                                                  text: file['name'] + " loaded.",
                                                  expire: 5000, // time in milliseconds after which the message will disappear
                                                  type: "info",
                                                  css: "my-popup"
                                               });    

                                               // open JIBO STATE SAMPLE tab 
                                               // $$("tabview").setValue("jiboStateSampleTab");                                     

                                               $$("jiboStateCsvUploader").disable();
                                               $$("removeDuplicatesBtn").disable()

                                               // Tabulate JSON data with Raw tab for visualization 
                                               if(enableDataSampling) {
                                                   convert2Table(JSON.parse(JSON.stringify(rawJiboState.slice(0, numOfSamples) )), "jiboStateTableId", enableRankFlag, true);
                                               } else {
                                                   // Tabulate  all CSV data 
                                                   convert2Table(JSON.parse(JSON.stringify(rawJiboState)), "jiboStateTableId", enableRankFlag, "header");
                                               }
                                            
                                               

                                               // Check if all needed CSV fils uploaded
                                               if(checkAllUpload()) {
                                                     $$("convertBtn").enable();
                                               }
                                          } else {

                                               alert('Incorrect file uploaded. Please upload the correct jibo state  CSV file (e.g. jibo_state.csv).');
                                          }
                                      }
                                  };

                                  reader.readAsText(file);
                                  return false;
                               }
                              }
                          },

                        ]} 

      ]}      

      let convertCsv = {view: "form", css: {"border-radius": "20px"},  elements: [ 
                         { type:"header", template:"Convert CSV"},
                         {rows: [ 
                          
                            { view: "switch", label: "Convert",  
                              offLabel: "Off", 
                              onLabel: "On", 
                              value: 0, 
                              labelWidth:130, 
                              id: "convertBtn", 
                              align: "left",

                              on:{        
                               onChange: function(newValue, oldValue, config) {   

                                    if(newValue) {

                                         if(Object.keys(rawJsonData[0]).length == 3) {
                                             //-- 3 col : "Datetime" "Event type" "Message"
                                            newCleanCSVSheet = jiboMapping3col(rawJsonData, rawStoryBookState, rawJiboState);

                                         } else {
                                            //-- More then 3 col : "Datetime" "Event type" "Message", "_1" "_2" "_3" etc
                                            newCleanCSVSheet = jiboMapping(rawJsonData, rawStoryBookState, rawJiboState);

                                         } 


                                         convert2Table(JSON.parse(JSON.stringify(newCleanCSVSheet)), "newCsvTableId", enableRankFlag, true);

                                         if(newCleanCSVSheet.length) {
                                              $$("downloadBtn").enable();
                                         }

                                    }

                              }
                            }
                          }

                      ]}
           ]}


       downloadNewCsv = (outCsvFileName) => {
             df = new dfd.DataFrame(newCleanCSVSheet);
             dfd.toCSV(df, { download: true, fileName:  outCsvFileName  });
           
       }


      let downloadCsvFile = {view: "form", css: {"border-radius": "20px"},  elements: [ 
              { type:"header", template:"Save CSV Output"  },

              {  cols: [
                    {   view: "label", label: "File Name",  
                        align: "left"
                    },                 
                    { view: "text", 
                      value: "out.csv",  
                      id: "fileNameToDL", 
                      disabled: false,
                      align: "left",
                      on: {
                        onChange: function(newValue, oldValue, config) {
                          if(newValue.length && isLetter(newValue[0])) {
                               $$("downloadBtn").enable();
                          } else {
                               $$("downloadBtn").disable();
                          }

                        }
                      }
                    }
                ]    
             },             

              {  cols: [
                    {   view: "label", label: "CSV File",  
                        align: "left"
                    },                 
                    { view: "button", label: "Save",  
                      id: "downloadBtn", 
                      css: "bt_1",
                      disabled: true,
                      align: "left",
                      click: function() {  

                            // if(allOutputSlices3DCC1DimArray.length) {
                            if(true) {  
                                 let downloadFileName = $$("fileNameToDL").getValue();
                                 
                                 if(downloadFileName.search(".csv") < 0) { 
                                      // if csv extension doesn't exist, then search will return -1
                                      downloadFileName = downloadFileName + ".csv";
                                 }

                                 downloadNewCsv(downloadFileName);

                            } else {
                                webix.message("No download Data");
                            }   
                      }  
                    }
                ]    
             }
          ]
       }



      // Define the tabview configuration with empty datatables
      let tabViewer = {
        view: "tabview",
        id: "tabviewId",
        gravity: 8, // Use gravity to control the height distribution (70% of the height)
        cells: [
          {
            header: "RAW CSV",
            id: "rawCsvTab",
            body: {
              view: "datatable",
              id: "rawCsvTableId",
              autoheight: false,
              autowidth: false,
              scroll: "xy",
              resizeColumn: true, // Enable column resizing
              css: "webix_shadow_medium", // Add CSS class for border        
              data: []
            }
          },
          {
            header: "STORY STATE SAMPLE",
            id: "storyStateSampleTab",
            body: {
              view: "datatable",
              id: "storyStateTableId",
              autoheight: false,
              autowidth: false,
              scroll: "xy",
              resizeColumn: true, // Enable column resizing
              css: "webix_shadow_medium", // Add CSS class for border        
              data: []
            }
          },
          {
            header: "JIBO STATE SAMPLE",
            id: "jiboStateSampleTab",
            body: {
              view: "datatable",
              id: "jiboStateTableId",
              autoheight: false,
              autowidth: false,
              scroll: "xy",
              resizeColumn: true, // Enable column resizing
              css: "webix_shadow_medium", // Add CSS class for border        
              data: []
            }
          },
          {
            header: "NEW MAPPED CSV",
            id: "newMappedCsvTab",
            body: {
              view: "datatable",
              id: "newCsvTableId",
              autoheight: false,
              autowidth: false,
              scroll: "xy",
              resizeColumn: true, // Enable column resizing
              css: "webix_shadow_medium", // Add CSS class for border        
              data: []
            }
          }
        ]
   
      };

      ///////////////////////////////////////////////

       webix.ui({
          margin:5,
          rows:[toolbar,
          {
          margin:20,
          padding: 20,
          cols: [{width: 250, rows:[
          rawCsvFile, storybookStateFile, jiboStateFile, convertCsv  , downloadCsvFile, dropboxAccessStatus, {}]},
          { rows: [  tabViewer, { gravity: 2,content: ""}]}]
        }]
        });
         
        


        $$("convertBtn").attachEvent("onItemClick", function() {
         
              if( $$("convertBtn").getValue() ) {

                 rawCsvFileNames = [];
                 rawCsvFileContents = [];
                 StorybookStateFileName = '';
                 jiboStateFileName = '';
                 rawJsonData = [];
                 rawStoryBookState = [];
                 rawJiboState = [];

                 $$("rawCsvUploader").enable();
                 $$("storyStateCsvUploader").enable();
                 $$("jiboStateCsvUploader").enable();
                 setInterval(function(){  }, 4000); 
                 setTimeout(function(){ $$("convertBtn").disable(); $$("convertBtn").setValue(0)}, swTimeOut);                  
       
              }
     
        });

        $$("convertBtn").disable();
           

   })  

  </script>

</body>
</html>